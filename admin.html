<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Dashboard Recyclage de Batteries VE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        header {
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .panel {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn-group {
            margin: 20px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.success {
            background: #2ecc71;
        }
        button.success:hover {
            background: #27ae60;
        }
        textarea {
            width: 100%;
            min-height: 500px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .panel h2 {
            margin-top: 0;
        }
        .notification {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            display: none;
        }
        .notification.success {
            background: #d5f5e3;
            border: 1px solid #2ecc71;
            color: #27ae60;
        }
        .notification.error {
            background: #f5d5d5;
            border: 1px solid #e74c3c;
            color: #c0392b;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .version-info {
            font-size: 14px;
            color: #777;
        }
        #jsonValidator {
            margin-top: 20px;
            color: #e74c3c;
        }
        .github-upload {
            background-color: #6e5494 !important;
        }
        .github-upload:hover {
            background-color: #583d7e !important;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f2f2f2;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <h1>Administration - Dashboard Recyclage de Batteries VE</h1>
        <p>Utilisez cet outil pour mettre à jour les données des installations de recyclage.</p>
        <a href="index.html" target="_blank" style="display: inline-block; margin-top: 10px; color: #3498db;">Voir le dashboard</a>
    </header>
    
    <div class="tabs">
        <div class="tab active" data-tab="editor">Éditeur JSON</div>
        <div class="tab" data-tab="importer">Importer des données</div>
        <div class="tab" data-tab="help">Instructions</div>
    </div>
    
    <div id="editor-tab" class="tab-content active">
        <div class="panel">
            <div class="action-bar">
                <h2>Éditeur de données JSON</h2>
                <span class="version-info" id="versionInfo">Version actuelle: -</span>
            </div>
            
            <div id="notification" class="notification"></div>
            
            <p>Modifiez directement le JSON ci-dessous, puis cliquez sur "Valider" pour vérifier la syntaxe avant de sauvegarder.</p>
            
            <textarea id="jsonEditor"></textarea>
            
            <div id="jsonValidator"></div>
            
            <div class="btn-group">
                <button id="loadButton">Charger les données actuelles</button>
                <button id="validateButton">Valider le JSON</button>
                <button id="saveButton" class="success" disabled>Sauvegarder</button>
                <button id="downloadButton">Télécharger le JSON</button>
                <button id="refreshVersionButton">Incrémenter la version</button>
                <!-- Le bouton GitHub Upload sera ajouté par le script -->
            </div>
        </div>
    </div>
    
    <div id="importer-tab" class="tab-content">
        <div class="panel">
            <h2>Importer des données</h2>
            <p>Vous pouvez importer un fichier JSON existant:</p>
            <input type="file" id="fileInput" accept=".json">
            <div class="btn-group">
                <button id="importButton">Importer</button>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Ajouter une nouvelle installation</h3>
                <p>Utilisez ce formulaire pour ajouter rapidement une nouvelle installation:</p>
                
                <form id="newRefinery">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label for="name">Nom:</label>
                            <input type="text" id="name" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                        </div>
                        <div>
                            <label for="location">Emplacement:</label>
                            <input type="text" id="location" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                        </div>
                        <div>
                            <label for="country">Pays:</label>
                            <select id="country" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                                <option value="Canada">Canada</option>
                                <option value="États-Unis">États-Unis</option>
                                <option value="Mexique">Mexique</option>
                            </select>
                        </div>
                        <div>
                            <label for="coordinates">Coordonnées (lat, lng):</label>
                            <input type="text" id="coordinates" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 45.5017, -73.5673">
                        </div>
                        <div>
                            <label for="status">Statut:</label>
                            <select id="status" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                                <option value="Opérationnel">Opérationnel</option>
                                <option value="En construction">En construction</option>
                                <option value="Planifié">Planifié</option>
                                <option value="Approuvé">Approuvé</option>
                                <option value="En suspens">En suspens</option>
                                <option value="En pause">En pause</option>
                            </select>
                        </div>
                        <div>
                            <label for="production">Production/Capacité:</label>
                            <input type="text" id="production" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 10 000 tonnes par an">
                        </div>
                        <div>
                            <label for="processing">Technologie:</label>
                            <input type="text" id="processing" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: Hydrométallurgie">
                        </div>
                        <div>
                            <label for="website">Site web:</label>
                            <input type="url" id="website" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: https://example.com">
                        </div>
                    </div>
                    
                    <div>
                        <label for="notes">Notes:</label>
                        <textarea id="notes" rows="3" style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
                    </div>
                    
                    <button type="submit" class="success" style="margin-top: 20px;">Ajouter l'installation</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="help-tab" class="tab-content">
        <div class="panel">
            <h2>Instructions</h2>
            <ol>
                <li>Cliquez sur "Charger les données actuelles" pour récupérer les données existantes</li>
                <li>Modifiez les données selon vos besoins dans l'éditeur JSON</li>
                <li>Cliquez sur "Valider" pour vérifier la syntaxe JSON</li>
                <li>Cliquez sur "Incrémenter la version" pour mettre à jour la version (important pour forcer la mise à jour chez les utilisateurs)</li>
                <li>Pour sauvegarder directement sur GitHub :
                    <ul>
                        <li>Cliquez sur "Uploader vers GitHub"</li>
                        <li>Entrez votre token personnel GitHub avec les droits "repo"</li>
                        <li>Entrez un message de commit</li>
                    </ul>
                </li>
                <li>Alternative : cliquez sur "Télécharger le JSON" et uploadez manuellement le fichier vers votre dépôt GitHub</li>
            </ol>
            
            <h3>Création d'un token GitHub</h3>
            <p>Pour utiliser la fonctionnalité d'upload direct vers GitHub, vous devez disposer d'un token d'accès personnel :</p>
            <ol>
                <li>Allez sur <a href="https://github.com/settings/tokens" target="_blank">https://github.com/settings/tokens</a></li>
                <li>Cliquez sur "Generate new token" puis "Generate new token (classic)"</li>
                <li>Donnez un nom à votre token, par exemple "Dashboard Admin"</li>
                <li>Sélectionnez le scope "repo" pour avoir accès en écriture à vos dépôts</li>
                <li>Cliquez sur "Generate token"</li>
                <li>Copiez le token généré (vous ne pourrez plus le voir ensuite)</li>
            </ol>
            <p><strong>Note de sécurité :</strong> Ne partagez jamais votre token GitHub. Ce script ne stocke pas votre token mais l'utilise uniquement pour l'opération d'upload en cours.</p>
        </div>
    </div>
    
    <script src="js/admin-uploader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const jsonEditor = document.getElementById('jsonEditor');
            const jsonValidator = document.getElementById('jsonValidator');
            const notification = document.getElementById('notification');
            const versionInfo = document.getElementById('versionInfo');
            const saveButton = document.getElementById('saveButton');
            
            let currentData = null;
            
            // Gestion des onglets
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Désactiver tous les onglets
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Activer l'onglet sélectionné
                    tab.classList.add('active');
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
            
            // Fonction pour afficher une notification
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                
                // Masquer la notification après 5 secondes
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
            
            // Charger les données JSON
            document.getElementById('loadButton').addEventListener('click', async function() {
                try {
                    const response = await fetch('data/refineries.json');
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    currentData = await response.json();
                    jsonEditor.value = JSON.stringify(currentData, null, 2);
                    versionInfo.textContent = `Version actuelle: ${currentData.version || 'non définie'}`;
                    
                    showNotification('Données chargées avec succès!', 'success');
                } catch (error) {
                    showNotification(`Erreur lors du chargement des données: ${error.message}`, 'error');
                    console.error('Erreur:', error);
                }
            });
            
            // Valider le JSON
            document.getElementById('validateButton').addEventListener('click', function() {
                jsonValidator.textContent = '';
                try {
                    const parsedData = JSON.parse(jsonEditor.value);
                    if (!parsedData.refineries || !Array.isArray(parsedData.refineries)) {
                        throw new Error('Le JSON doit contenir un tableau "refineries"');
                    }
                    if (!parsedData.version) {
                        throw new Error('Le JSON doit contenir une propriété "version"');
                    }
                    
                    currentData = parsedData;
                    showNotification('JSON valide!', 'success');
                    saveButton.disabled = false;
                } catch (error) {
                    jsonValidator.textContent = `Erreur: ${error.message}`;
                    saveButton.disabled = true;
                }
            });
            
            // Incrémenter la version
            document.getElementById('refreshVersionButton').addEventListener('click', function() {
                try {
                    const parsedData = JSON.parse(jsonEditor.value);
                    const currentDate = new Date();
                    const formattedDate = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    
                    // Vérifier si la date est la même que celle de la version actuelle
                    const currentVersion = parsedData.version || '';
                    let newVersion;
                    
                    if (currentVersion.startsWith(formattedDate)) {
                        // Incrémenter la version pour la même date
                        const versionParts = currentVersion.split('-v');
                        const versionNumber = versionParts.length > 1 ? parseInt(versionParts[1]) || 0 : 0;
                        newVersion = `${formattedDate}-v${versionNumber + 1}`;
                    } else {
                        // Nouvelle date, commencer à v1
                        newVersion = `${formattedDate}-v1`;
                    }
                    
                    parsedData.version = newVersion;
                    jsonEditor.value = JSON.stringify(parsedData, null, 2);
                    versionInfo.textContent = `Version actuelle: ${newVersion}`;
                    
                    showNotification(`Version incrémentée à ${newVersion}`, 'success');
                } catch (error) {
                    showNotification(`Erreur lors de l'incrémentation de la version: ${error.message}`, 'error');
                }
            });
            
            // Sauvegarder le JSON
            document.getElementById('saveButton').addEventListener('click', function() {
                if (!currentData) {
                    showNotification('Aucune donnée à sauvegarder', 'error');
                    return;
                }
                
                const dataStr = jsonEditor.value;
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'refineries.json';
                link.click();
                
                showNotification('Fichier JSON téléchargé', 'success');
            });
            
            // Télécharger le JSON (même fonction que sauvegarder)
            document.getElementById('downloadButton').addEventListener('click', function() {
                try {
                    const dataStr = jsonEditor.value;
                    JSON.parse(dataStr); // Vérifier que c'est un JSON valide
                    
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'refineries.json';
                    link.click();
                    
                    showNotification('Fichier JSON téléchargé', 'success');
                } catch (error) {
                    showNotification(`Erreur: ${error.message}. Veuillez valider le JSON d'abord.`, 'error');
                }
            });
            
            // Importer un fichier JSON
            document.getElementById('importButton').addEventListener('click', function() {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    showNotification('Veuillez sélectionner un fichier', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const parsedData = JSON.parse(e.target.result);
                        jsonEditor.value = JSON.stringify(parsedData, null, 2);
                        
                        if (parsedData.version) {
                            versionInfo.textContent = `Version actuelle: ${parsedData.version}`;
                        }
                        
                        showNotification('Fichier importé avec succès!', 'success');
                    } catch (error) {
                        showNotification(`Erreur lors de l'importation du fichier: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            });
            
            // Ajouter une nouvelle installation
            document.getElementById('newRefinery').addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    // Vérifier si les données JSON sont chargées
                    const jsonData = jsonEditor.value ? JSON.parse(jsonEditor.value) : null;
                    if (!jsonData || !jsonData.refineries) {
                        showNotification('Veuillez d\'abord charger les données existantes', 'error');
                        return;
                    }
                    
                    // Récupérer les valeurs du formulaire
                    const name = document.getElementById('name').value;
                    const location = document.getElementById('location').value;
                    const country = document.getElementById('country').value;
                    const coordinates = document.getElementById('coordinates').value.split(',').map(c => parseFloat(c.trim()));
                    const status = document.getElementById('status').value;
                    const production = document.getElementById('production').value || 'N/A';
                    const processing = document.getElementById('processing').value || 'N/A';
                    const website = document.getElementById('website').value || '#';
                    const notes = document.getElementById('notes').value || '';
                    
                    // Vérifier les coordonnées
                    if (coordinates.length !== 2 || isNaN(coordinates[0]) || isNaN(coordinates[1])) {
                        showNotification('Coordonnées invalides. Format attendu: latitude, longitude', 'error');
                        return;
                    }
                    
                    // Trouver le prochain ID disponible
                    const maxId = Math.max(...jsonData.refineries.map(r => r.id), 0);
                    const newId = maxId + 1;
                    
                    // Créer le nouvel objet installation
                    const newRefinery = {
                        id: newId,
                        name,
                        location,
                        country,
                        coordinates,
                        status,
                        production,
                        processing,
                        website,
                        notes
                    };
                    
                    // Ajouter l'installation aux données
                    jsonData.refineries.push(newRefinery);
                    
                    // Mettre à jour l'éditeur JSON
                    jsonEditor.value = JSON.stringify(jsonData, null, 2);
                    
                    // Valider les données
                    document.getElementById('validateButton').click();
                    
                    // Réinitialiser le formulaire
                    document.getElementById('newRefinery').reset();
                    
                    showNotification(`Installation "${name}" ajoutée avec succès!`, 'success');
                } catch (error) {
                    showNotification(`Erreur lors de l'ajout de l'installation: ${error.message}`, 'error');
                }
            });
            
            // Charger les données au démarrage
            document.getElementById('loadButton').click();
        });
    </script>
</body>
</html>