<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Dashboard Recyclage de Batteries VE</title>
    
    <!-- Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        header {
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .panel {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn-group {
            margin: 20px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.success {
            background: #2ecc71;
        }
        button.success:hover {
            background: #27ae60;
        }
        textarea {
            width: 100%;
            min-height: 500px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .panel h2 {
            margin-top: 0;
        }
        .notification {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            display: none;
        }
        .notification.success {
            background: #d5f5e3;
            border: 1px solid #2ecc71;
            color: #27ae60;
        }
        .notification.error {
            background: #f5d5d5;
            border: 1px solid #e74c3c;
            color: #c0392b;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .version-info {
            font-size: 14px;
            color: #777;
        }
        #jsonValidator {
            margin-top: 20px;
            color: #e74c3c;
        }
        .github-upload {
            background-color: #6e5494 !important;
        }
        .github-upload:hover {
            background-color: #583d7e !important;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f2f2f2;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .logout-btn {
            margin-left: 10px;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        /* Styles pour le tableau des installations */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        .data-table .action-buttons {
            white-space: nowrap;
        }
        .data-table .action-buttons button {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 12px;
        }
        /* Styles pour les filtres */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filter-bar select, .filter-bar input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .filter-bar label {
            margin-right: 5px;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #333;
        }
        /* Style pour l'indicateur de synchronisation */
        .sync-indicator {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
        }
        .sync-indicator .dot {
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { background-color: #4CAF50; }
            50% { background-color: #FFC107; }
            100% { background-color: #4CAF50; }
        }
    </style>
</head>
<body>
    <!-- Script d'authentification - Doit être chargé en premier -->
    <script src="js/auth.js"></script>
    <script>
        // Protéger la page
        document.addEventListener('DOMContentLoaded', function() {
            protectAdminPage();
        });
    </script>
    
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Administration - Dashboard Recyclage de Batteries VE</h1>
            <button id="logout-btn" class="logout-btn" onclick="logout()">Déconnexion</button>
        </div>
        <p>Utilisez cet outil pour mettre à jour les données des installations de recyclage.</p>
        <a href="index.html" target="_blank" style="display: inline-block; margin-top: 10px; color: #3498db;">Voir le dashboard</a>
    </header>
    
    <div class="tabs">
        <div class="tab" id="table-nav" data-tab="table">Tableau des installations</div>
        <div class="tab" id="editor-nav" data-tab="editor">Éditeur JSON</div>
        <div class="tab" id="importer-nav" data-tab="importer">Importer des données</div>
        <div class="tab" id="help-nav" data-tab="help">Instructions</div>
    </div>
    
    <!-- Nouveau tableau des installations -->
    <div id="table-tab" class="tab-content">
        <div class="panel">
            <div class="action-bar">
                <h2>Gestion des installations de recyclage</h2>
                <span class="version-info" id="tableVersionInfo">Version actuelle: -</span>
            </div>
            
            <div id="table-notification" class="notification"></div>
            
            <div class="filter-bar">
                <div>
                    <label for="filter-country">Pays:</label>
                    <select id="filter-country">
                        <option value="all">Tous</option>
                        <option value="Canada">Canada</option>
                        <option value="États-Unis">États-Unis</option>
                        <option value="Mexique">Mexique</option>
                    </select>
                </div>
                <div>
                    <label for="filter-status">Statut:</label>
                    <select id="filter-status">
                        <option value="all">Tous</option>
                        <option value="Opérationnel">Opérationnel</option>
                        <option value="En construction">En construction</option>
                        <option value="Planifié">Planifié</option>
                        <option value="Approuvé">Approuvé</option>
                        <option value="En pause">En pause</option>
                    </select>
                </div>
                <div>
                    <label for="filter-search">Recherche:</label>
                    <input type="text" id="filter-search" placeholder="Rechercher...">
                </div>
                <button id="add-new-btn" class="success">Ajouter une installation</button>
            </div>
            
            <div class="table-container" style="overflow-x: auto;">
                <table id="refineries-data-table" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Emplacement</th>
                            <th>Pays</th>
                            <th>Statut</th>
                            <th>Production</th>
                            <th>Technologie</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="refineries-table-body">
                        <!-- Rempli dynamiquement par JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="btn-group">
                <button id="refresh-table-btn">Rafraîchir</button>
                <button id="save-all-changes-btn" class="success">Enregistrer les modifications</button>
                <button id="increment-version-btn">Incrémenter la version</button>
                <button id="export-table-btn">Exporter (JSON)</button>
                <button id="upload-github-btn" class="github-upload">Uploader vers GitHub</button>
            </div>
        </div>
    </div>
    
    <div id="editor-tab" class="tab-content">
        <div class="panel">
            <div class="action-bar">
                <h2>Éditeur de données JSON</h2>
                <span class="version-info" id="versionInfo">Version actuelle: -</span>
            </div>
            
            <div id="notification" class="notification"></div>
            
            <p>Modifiez directement le JSON ci-dessous, puis cliquez sur "Valider" pour vérifier la syntaxe avant de sauvegarder.</p>
            
            <textarea id="jsonEditor"></textarea>
            
            <div id="jsonValidator"></div>
            
            <div class="btn-group">
                <button id="loadButton">Charger les données actuelles</button>
                <button id="validateButton">Valider le JSON</button>
                <button id="saveButton" class="success" disabled>Sauvegarder</button>
                <button id="downloadButton">Télécharger le JSON</button>
                <button id="refreshVersionButton">Incrémenter la version</button>
            </div>
        </div>
    </div>
    
    <div id="importer-tab" class="tab-content">
        <div class="panel">
            <h2>Importer des données</h2>
            <p>Vous pouvez importer un fichier JSON existant:</p>
            <input type="file" id="fileInput" accept=".json">
            <div class="btn-group">
                <button id="importButton">Importer</button>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Ajouter une nouvelle installation</h3>
                <p>Utilisez ce formulaire pour ajouter rapidement une nouvelle installation:</p>
                
                <form id="newRefinery">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label for="name">Nom:</label>
                            <input type="text" id="name" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                        </div>
                        <div>
                            <label for="location">Emplacement:</label>
                            <input type="text" id="location" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                        </div>
                        <div>
                            <label for="country">Pays:</label>
                            <select id="country" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                                <option value="Canada">Canada</option>
                                <option value="États-Unis">États-Unis</option>
                                <option value="Mexique">Mexique</option>
                            </select>
                        </div>
                        <div>
                            <label for="coordinates">Coordonnées (lat, lng):</label>
                            <input type="text" id="coordinates" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 45.5017, -73.5673">
                        </div>
                        <div>
                            <label for="status">Statut:</label>
                            <select id="status" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                                <option value="Opérationnel">Opérationnel</option>
                                <option value="En construction">En construction</option>
                                <option value="Planifié">Planifié</option>
                                <option value="Approuvé">Approuvé</option>
                                <option value="En pause">En pause</option>
                            </select>
                        </div>
                        <div>
                            <label for="production">Production/Capacité:</label>
                            <input type="text" id="production" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 10 000 tonnes par an">
                        </div>
                        <div>
                            <label for="processing">Technologie:</label>
                            <input type="text" id="processing" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: Hydrométallurgie">
                        </div>
                        <div>
                            <label for="website">Site web:</label>
                            <input type="url" id="website" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: https://example.com">
                        </div>
                    </div>
                    
                    <div>
                        <label for="notes">Notes:</label>
                        <textarea id="notes" rows="3" style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
                    </div>
                    
                    <button type="submit" class="success" style="margin-top: 20px;">Ajouter l'installation</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="help-tab" class="tab-content">
        <div class="panel">
            <h2>Instructions</h2>
            <ol>
                <li>Utilisez l'onglet <strong>Tableau des installations</strong> pour une gestion visuelle et facile des données</li>
                <li>Vous pouvez filtrer, rechercher, ajouter, modifier et supprimer des installations directement depuis le tableau</li>
                <li>Pour des modifications avancées ou l'import/export des données :
                    <ul>
                        <li>Utilisez l'onglet <strong>Éditeur JSON</strong> pour modifier directement le fichier JSON complet</li>
                        <li>Utilisez l'onglet <strong>Importer des données</strong> pour importer un fichier JSON ou ajouter rapidement une nouvelle installation</li>
                    </ul>
                </li>
                <li>N'oubliez pas de <strong>Incrémenter la version</strong> après vos modifications pour forcer la mise à jour chez les utilisateurs</li>
                <li>Cliquez sur <strong>Enregistrer les modifications</strong> pour sauvegarder vos changements</li>
                <li>Pour sauvegarder sur GitHub, utilisez le bouton <strong>Uploader vers GitHub</strong></li>
            </ol>
            
            <h3>Création d'un token GitHub</h3>
            <p>Pour utiliser la fonctionnalité d'upload direct vers GitHub, vous devez disposer d'un token d'accès personnel :</p>
            <ol>
                <li>Allez sur <a href="https://github.com/settings/tokens" target="_blank">https://github.com/settings/tokens</a></li>
                <li>Cliquez sur "Generate new token" puis "Generate new token (classic)"</li>
                <li>Donnez un nom à votre token, par exemple "Dashboard Admin"</li>
                <li>Sélectionnez le scope "repo" pour avoir accès en écriture à vos dépôts</li>
                <li>Cliquez sur "Generate token"</li>
                <li>Copiez le token généré (vous ne pourrez plus le voir ensuite)</li>
            </ol>
            <p><strong>Note de sécurité :</strong> Ne partagez jamais votre token GitHub. Ce script ne stocke pas votre token mais l'utilise uniquement pour l'opération d'upload en cours.</p>
        </div>
    </div>
    
    <!-- Modal pour ajouter/modifier une installation -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="edit-modal-close">&times;</span>
            <h2 id="edit-modal-title">Ajouter une installation</h2>
            
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label for="edit-name">Nom:</label>
                        <input type="text" id="edit-name" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                    </div>
                    <div>
                        <label for="edit-location">Emplacement:</label>
                        <input type="text" id="edit-location" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                    </div>
                    <div>
                        <label for="edit-country">Pays:</label>
                        <select id="edit-country" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                            <option value="Canada">Canada</option>
                            <option value="États-Unis">États-Unis</option>
                            <option value="Mexique">Mexique</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-coordinates">Coordonnées (lat, lng):</label>
                        <input type="text" id="edit-coordinates" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 45.5017, -73.5673">
                    </div>
                    <div>
                        <label for="edit-status">Statut:</label>
                        <select id="edit-status" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                            <option value="Opérationnel">Opérationnel</option>
                            <option value="En construction">En construction</option>
                            <option value="Planifié">Planifié</option>
                            <option value="Approuvé">Approuvé</option>
                            <option value="En pause">En pause</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-production">Production/Capacité:</label>
                        <input type="text" id="edit-production" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 10 000 tonnes par an">
                    </div>
                    <div>
                        <label for="edit-processing">Technologie:</label>
                        <input type="text" id="edit-processing" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: Hydrométallurgie">
                    </div>
                    <div>
                        <label for="edit-website">Site web:</label>
                        <input type="url" id="edit-website" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: https://example.com">
                    </div>
                </div>
                
                <div>
                    <label for="edit-notes">Notes:</label>
                    <textarea id="edit-notes" rows="3" style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" id="edit-cancel" class="danger">Annuler</button>
                    <button type="submit" id="edit-save" class="success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de confirmation pour la suppression -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h2>Confirmer la suppression</h2>
            <p>Êtes-vous sûr de vouloir supprimer cette installation? Cette action est irréversible.</p>
            <p><strong id="delete-refinery-name"></strong></p>
            <div style="margin-top: 20px; text-align: right;">
                <button id="delete-cancel" style="background-color: #ccc; color: #333;">Annuler</button>
                <button id="delete-confirm" class="danger">Supprimer</button>
            </div>
            <input type="hidden" id="delete-id">
        </div>
    </div>
    
    <!-- Modal pour GitHub upload -->
    <div id="github-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="github-modal-close">&times;</span>
            <h2>Upload vers GitHub</h2>
            <div style="margin-bottom: 15px;">
                <label for="github-token">Token GitHub:</label>
                <input type="password" id="github-token" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ghp_votre_token_personnel">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="github-message">Message de commit:</label>
                <input type="text" id="github-message" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="Mise à jour des données d'installations">
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="github-cancel" style="background-color: #ccc; color: #333;">Annuler</button>
                <button id="github-upload" class="github-upload">Uploader</button>
            </div>
        </div>
    </div>
    
    <!-- Indicateur de synchronisation -->
    <div class="sync-indicator">
        <div class="dot"></div>
        <span>Synchronisation active</span>
    </div>

    <!-- Scripts -->
    <script src="js/data.js"></script>
    <script src="js/admin-uploader.js"></script>
    <script src="js/admin-table.js"></script>
    <script src="js/sync.js"></script>
    <!-- Nouveau script de synchronisation amélioré -->
    <script src="js/admin-sync.js"></script>
    <script>
        // Fonction pour activer un onglet
        function activateTab(tabName) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer l'onglet spécifié
            document.getElementById(tabName + '-nav').classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            console.log(`Onglet activé: ${tabName}`);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initialisation de la page d'administration...");
            
            // Gestion des onglets
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    activateTab(tabName);
                });
            });
            
            // Initialisation de l'éditeur JSON
            document.getElementById('loadButton').addEventListener('click', async function() {
                try {
                    // Charger d'abord depuis localStorage pour avoir les données les plus récentes
                    const localData = localStorage.getItem('lithiumRefineries');
                    let jsonData = null;
                    
                    if (localData) {
                        // Si on a des données locales, on les utilise mais on récupère la version depuis le fichier
                        const response = await fetch('data/refineries.json');
                        if (response.ok) {
                            const fileData = await response.json();
                            jsonData = fileData;
                            jsonData.refineries = JSON.parse(localData);
                        } else {
                            // Si on ne peut pas accéder au fichier JSON, on crée un objet minimal
                            jsonData = {
                                version: localStorage.getItem('dashboardVersion') || 'locale',
                                refineries: JSON.parse(localData),
                                status_colors: STATUS_COLORS || {
                                    "Opérationnel": "#00AA00",
                                    "En construction": "#0000FF",
                                    "Planifié": "#FFA500",
                                    "Approuvé": "#FFA500",
                                    "En pause": "#FF0000"
                                }
                            };
                        }
                    } else {
                        // Si pas de données locales, charger depuis le fichier JSON
                        const response = await fetch('data/refineries.json');
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        jsonData = await response.json();
                    }
                    
                    document.getElementById('jsonEditor').value = JSON.stringify(jsonData, null, 2);
                    document.getElementById('versionInfo').textContent = `Version actuelle: ${jsonData.version || 'non définie'}`;
                    
                    showNotification(document.getElementById('notification'), 'Données chargées avec succès!', 'success');
                } catch (error) {
                    showNotification(document.getElementById('notification'), `Erreur lors du chargement des données: ${error.message}`, 'error');
                    console.error('Erreur:', error);
                }
            });
            
            // Initialisation de la fonctionnalité GitHub Upload
            document.getElementById('upload-github-btn').addEventListener('click', function() {
                document.getElementById('github-modal').style.display = 'block';
            });
            
            document.getElementById('github-modal-close').addEventListener('click', function() {
                document.getElementById('github-modal').style.display = 'none';
            });
            
            document.getElementById('github-cancel').addEventListener('click', function() {
                document.getElementById('github-modal').style.display = 'none';
            });
            
            // Activer l'onglet Tableau par défaut
            setTimeout(() => {
                activateTab('table');
                console.log("Onglet tableau activé par défaut");
            }, 100);
            
            // Configurer le comportement de synchronisation
            const syncIndicator = document.querySelector('.sync-indicator');
            if (syncIndicator) {
                syncIndicator.style.display = 'none';
                
                // Montrer l'indicateur pendant la synchronisation
                document.addEventListener('lithium_admin_data_changed', function() {
                    syncIndicator.style.display = 'flex';
                    setTimeout(() => {
                        syncIndicator.style.display = 'none';
                    }, 2000);
                });
            }
        });
    </script>
</body>
</html>