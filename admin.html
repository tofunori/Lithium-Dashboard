<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Dashboard Recyclage de Batteries VE</title>
    
    <!-- Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        header {
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .panel {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn-group {
            margin: 20px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.success {
            background: #2ecc71;
        }
        button.success:hover {
            background: #27ae60;
        }
        textarea {
            width: 100%;
            min-height: 500px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .panel h2 {
            margin-top: 0;
        }
        .notification {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            display: none;
        }
        .notification.success {
            background: #d5f5e3;
            border: 1px solid #2ecc71;
            color: #27ae60;
        }
        .notification.error {
            background: #f5d5d5;
            border: 1px solid #e74c3c;
            color: #c0392b;
        }
        .notification.info {
            background: #d9edf7;
            border: 1px solid #3498db;
            color: #2980b9;
        }
        .notification.warning {
            background: #fcf8e3;
            border: 1px solid #f39c12;
            color: #e67e22;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .version-info {
            font-size: 14px;
            color: #777;
        }
        #jsonValidator {
            margin-top: 20px;
            color: #e74c3c;
        }
        .github-upload {
            background-color: #6e5494 !important;
        }
        .github-upload:hover {
            background-color: #583d7e !important;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f2f2f2;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        .data-table .action-buttons {
            white-space: nowrap;
        }
        .data-table .action-buttons button {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 12px;
        }
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filter-bar select, .filter-bar input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .filter-bar label {
            margin-right: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #333;
        }
        .logout-btn {
            margin-left: 10px;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        .sync-indicator {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
        }
        .sync-indicator .dot {
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { background-color: #4CAF50; }
            50% { background-color: #FFC107; }
            100% { background-color: #4CAF50; }
        }
        /* Modal de login */
        #login-modal {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        .login-modal-content {
            background-color: white;
            border-radius: 5px;
            width: 400px;
            padding: 20px;
            max-width: 90%;
        }
        .login-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .login-modal-body form {
            display: flex;
            flex-direction: column;
        }
        .login-modal-body input {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .login-modal-body button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .login-modal-body button:hover {
            background: #2980b9;
        }
        #login-message {
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Modal de connexion -->
    <div id="login-modal" class="modal" style="display: none;">
        <div class="login-modal-content">
            <div class="login-modal-header">
                <h3>Connexion √† l'administration</h3>
                <span class="close login-modal-close">&times;</span>
            </div>
            <div class="login-modal-body">
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="Nom d'utilisateur" required>
                    <input type="password" id="login-password" placeholder="Mot de passe" required>
                    <button type="submit">Se connecter</button>
                </form>
                <p id="login-message"></p>
            </div>
        </div>
    </div>
    
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Administration - Dashboard Recyclage de Batteries VE</h1>
            <button id="logout-btn" class="logout-btn" onclick="logout()">D√©connexion</button>
        </div>
        <p>Utilisez cet outil pour mettre √† jour les donn√©es des installations de recyclage.</p>
        <a href="index.html" target="_blank" style="display: inline-block; margin-top: 10px; color: #3498db;">Voir le dashboard</a>
    </header>
    
    <div class="tabs">
        <div class="tab active" data-tab="table">Tableau des installations</div>
        <div class="tab" data-tab="editor">√âditeur JSON</div>
        <div class="tab" data-tab="help">Instructions</div>
    </div>
    
    <!-- Tableau des installations -->
    <div id="table-tab" class="tab-content active">
        <div class="panel">
            <div class="action-bar">
                <h2>Gestion des installations de recyclage</h2>
                <span class="version-info" id="tableVersionInfo">Version actuelle: -</span>
            </div>
            
            <div id="table-notification" class="notification"></div>
            
            <div class="filter-bar">
                <div>
                    <label for="country-filter">Pays:</label>
                    <select id="country-filter">
                        <option value="all">Tous</option>
                        <option value="Canada">Canada</option>
                        <option value="√âtats-Unis">√âtats-Unis</option>
                        <option value="Mexique">Mexique</option>
                    </select>
                </div>
                <div>
                    <label for="status-filter">Statut:</label>
                    <select id="status-filter">
                        <option value="all">Tous</option>
                        <option value="Op√©rationnel">Op√©rationnel</option>
                        <option value="En construction">En construction</option>
                        <option value="Planifi√©">Planifi√©</option>
                        <option value="Approuv√©">Approuv√©</option>
                        <option value="En pause">En pause</option>
                    </select>
                </div>
                <div>
                    <label for="search-filter">Recherche:</label>
                    <input type="text" id="search-filter" placeholder="Rechercher...">
                </div>
                <button id="add-installation-btn" class="success">Ajouter une installation</button>
            </div>
            
            <div class="table-container" style="overflow-x: auto;">
                <table id="refineries-table" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Emplacement</th>
                            <th>Pays</th>
                            <th>Statut</th>
                            <th>Production</th>
                            <th>Technologie</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="refineries-table-body">
                        <!-- Rempli dynamiquement par JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="btn-group">
                <button id="refresh-btn">Rafra√Æchir</button>
                <button id="save-changes-btn" class="success">Enregistrer les modifications</button>
                <button id="increment-version-btn">Incr√©menter la version</button>
                <button id="export-btn">Exporter (JSON)</button>
                <button id="import-btn">Importer un fichier JSON</button>
                <button id="upload-github-btn" class="github-upload">Uploader vers GitHub</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>
        </div>
    </div>
    
    <!-- √âditeur JSON -->
    <div id="editor-tab" class="tab-content">
        <div class="panel">
            <div class="action-bar">
                <h2>√âditeur de donn√©es JSON</h2>
                <span class="version-info" id="editorVersionInfo">Version actuelle: -</span>
            </div>
            
            <div id="editor-notification" class="notification"></div>
            
            <p>Modifiez directement le JSON ci-dessous, puis cliquez sur "Valider" pour v√©rifier la syntaxe avant de sauvegarder.</p>
            
            <textarea id="json-editor"></textarea>
            
            <div id="json-validator"></div>
            
            <div class="btn-group">
                <button id="validate-btn">Valider le JSON</button>
                <button id="apply-btn" class="success" disabled>Appliquer les modifications</button>
                <button id="download-btn">T√©l√©charger le JSON</button>
                <button id="reload-btn">Recharger depuis le fichier</button>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div id="help-tab" class="tab-content">
        <div class="panel">
            <h2>Instructions d'utilisation</h2>
            
            <h3>Fonctionnalit√©s principales</h3>
            <ul>
                <li><strong>Tableau des installations</strong> - Vue compl√®te des installations avec filtres et recherche</li>
                <li><strong>√âditeur JSON</strong> - Modification directe du JSON pour les utilisateurs avanc√©s</li>
                <li><strong>Import/Export</strong> - Sauvegarde et restauration des donn√©es</li>
                <li><strong>Synchronisation automatique</strong> - Les changements sont r√©percut√©s automatiquement sur toutes les pages ouvertes</li>
            </ul>
            
            <h3>Gestion des installations</h3>
            <ol>
                <li>Utilisez les <strong>filtres</strong> pour trouver rapidement des installations</li>
                <li>Cliquez sur <strong>Ajouter une installation</strong> pour cr√©er une nouvelle entr√©e</li>
                <li>Utilisez les boutons <strong>Modifier</strong> et <strong>Supprimer</strong> pour g√©rer les installations existantes</li>
                <li>N'oubliez pas de cliquer sur <strong>Enregistrer les modifications</strong> pour t√©l√©charger le fichier JSON mis √† jour</li>
                <li>Utilisez <strong>Incr√©menter la version</strong> pour forcer la mise √† jour du dashboard pour tous les utilisateurs</li>
            </ol>
            
            <h3>En cas de probl√®me</h3>
            <p>Si vous rencontrez des difficult√©s :</p>
            <ol>
                <li>Utilisez le bouton <strong>Rafra√Æchir</strong> pour recharger les donn√©es</li>
                <li>Essayez d'<strong>Importer un fichier JSON</strong> existant</li>
                <li>V√©rifiez la structure de votre fichier JSON dans l'onglet √âditeur</li>
                <li>Effacez le cache de votre navigateur si les probl√®mes persistent</li>
            </ol>
            
            <h3>Cr√©ation d'un token GitHub</h3>
            <p>Pour utiliser la fonctionnalit√© d'upload direct vers GitHub, vous devez disposer d'un token d'acc√®s personnel :</p>
            <ol>
                <li>Allez sur <a href="https://github.com/settings/tokens" target="_blank">https://github.com/settings/tokens</a></li>
                <li>Cliquez sur "Generate new token" puis "Generate new token (classic)"</li>
                <li>Donnez un nom √† votre token, par exemple "Dashboard Admin"</li>
                <li>S√©lectionnez le scope "repo" pour avoir acc√®s en √©criture √† vos d√©p√¥ts</li>
                <li>Cliquez sur "Generate token"</li>
                <li>Copiez le token g√©n√©r√© (vous ne pourrez plus le voir ensuite)</li>
            </ol>
            <p><strong>Note de s√©curit√© :</strong> Ne partagez jamais votre token GitHub. Ce script ne stocke pas votre token mais l'utilise uniquement pour l'op√©ration d'upload en cours.</p>
        </div>
    </div>
    
    <!-- Modal pour ajouter/modifier une installation -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="edit-modal-close">&times;</span>
            <h2 id="edit-modal-title">Ajouter/Modifier une installation</h2>
            
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label for="edit-name">Nom:</label>
                        <input type="text" id="edit-name" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                    </div>
                    <div>
                        <label for="edit-location">Emplacement:</label>
                        <input type="text" id="edit-location" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                    </div>
                    <div>
                        <label for="edit-country">Pays:</label>
                        <select id="edit-country" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                            <option value="Canada">Canada</option>
                            <option value="√âtats-Unis">√âtats-Unis</option>
                            <option value="Mexique">Mexique</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-coordinates">Coordonn√©es (lat, lng):</label>
                        <input type="text" id="edit-coordinates" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 45.5017, -73.5673">
                    </div>
                    <div>
                        <label for="edit-status">Statut:</label>
                        <select id="edit-status" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                            <option value="Op√©rationnel">Op√©rationnel</option>
                            <option value="En construction">En construction</option>
                            <option value="Planifi√©">Planifi√©</option>
                            <option value="Approuv√©">Approuv√©</option>
                            <option value="En pause">En pause</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-production">Production/Capacit√©:</label>
                        <input type="text" id="edit-production" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 10 000 tonnes par an">
                    </div>
                    <div>
                        <label for="edit-processing">Technologie:</label>
                        <input type="text" id="edit-processing" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: Hydrom√©tallurgie">
                    </div>
                    <div>
                        <label for="edit-website">Site web:</label>
                        <input type="url" id="edit-website" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: https://example.com">
                    </div>
                </div>
                
                <div>
                    <label for="edit-notes">Notes:</label>
                    <textarea id="edit-notes" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; min-height: 100px;"></textarea>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" id="edit-cancel" class="danger">Annuler</button>
                    <button type="submit" id="edit-save" class="success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de confirmation pour la suppression -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h2>Confirmer la suppression</h2>
            <p>√ätes-vous s√ªr de vouloir supprimer cette installation? Cette action est irr√©versible.</p>
            <p><strong id="delete-refinery-name"></strong></p>
            <div style="margin-top: 20px; text-align: right;">
                <button id="delete-cancel" style="background-color: #ccc; color: #333;">Annuler</button>
                <button id="delete-confirm" class="danger">Supprimer</button>
            </div>
            <input type="hidden" id="delete-id">
        </div>
    </div>
    
    <!-- Modal pour GitHub upload -->
    <div id="github-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="github-modal-close">&times;</span>
            <h2>Upload vers GitHub</h2>
            <div style="margin-bottom: 15px;">
                <label for="github-token">Token GitHub:</label>
                <input type="password" id="github-token" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ghp_votre_token_personnel">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="github-message">Message de commit:</label>
                <input type="text" id="github-message" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="Mise √† jour des donn√©es d'installations">
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="github-cancel" style="background-color: #ccc; color: #333;">Annuler</button>
                <button id="github-upload" class="github-upload">Uploader</button>
            </div>
        </div>
    </div>
    
    <!-- Indicateur de synchronisation -->
    <div class="sync-indicator" style="display: none;">
        <div class="dot"></div>
        <span>Synchronisation active</span>
    </div>

    <!-- Scripts int√©gr√©s -->
    <script>
    // ===== GESTION DE L'AUTHENTIFICATION =====
    const AUTH_KEY = 'lithium_dashboard_auth';
    const DEFAULT_CREDENTIALS = {
        username: 'admin',
        password: 'lithium2025'
    };

    // V√©rifie si l'utilisateur est connect√©
    function isLoggedIn() {
        return localStorage.getItem(AUTH_KEY) === 'true';
    }

    // Connecte l'utilisateur
    function login(username, password) {
        if (username === DEFAULT_CREDENTIALS.username && password === DEFAULT_CREDENTIALS.password) {
            localStorage.setItem(AUTH_KEY, 'true');
            return true;
        }
        return false;
    }

    // D√©connecte l'utilisateur
    function logout() {
        localStorage.removeItem(AUTH_KEY);
        window.location.href = 'index.html';
    }

    // Prot√®ge la page admin
    function protectAdminPage() {
        if (!isLoggedIn()) {
            window.location.href = 'index.html?access=denied';
        }
    }

    // Initialise le formulaire de connexion
    function initLoginForm() {
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        
        // G√©rer la soumission du formulaire
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                if (login(username, password)) {
                    loginMessage.textContent = 'Connexion r√©ussie';
                    loginMessage.style.color = 'green';
                    // Rediriger vers admin apr√®s un court d√©lai
                    setTimeout(() => {
                        loginModal.style.display = 'none';
                        window.location.reload();
                    }, 1000);
                } else {
                    loginMessage.textContent = 'Identifiants incorrects';
                    loginMessage.style.color = 'red';
                }
            });
        }
        
        // Fermer le modal lorsque l'utilisateur clique sur la croix ou √† l'ext√©rieur
        const closeButtons = document.querySelectorAll('.login-modal-close');
        closeButtons.forEach(button => {
            if (button) {
                button.addEventListener('click', () => {
                    loginModal.style.display = 'none';
                });
            }
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
    }
    
    // ===== SYNCHRONISATION DES DONN√âES =====
    const SYNC_KEY = 'lithium_dashboard_sync';
    const DATA_KEY = 'lithiumRefineries';
    
    // Variable pour suivre la derni√®re mise √† jour connue
    let lastKnownUpdate = Date.now();
    let isSyncActive = false; // √âviter les boucles infinies
    
    // Fonction pour synchroniser les donn√©es
    function syncData() {
        // √âviter les boucles de synchronisation
        if (isSyncActive) return;
        isSyncActive = true;
        
        try {
            // Charger les donn√©es √† jour depuis le localStorage
            const syncData = localStorage.getItem(SYNC_KEY);
            const timestamp = syncData ? parseInt(syncData) : 0;
            
            // Si les donn√©es sont plus r√©centes que notre derni√®re mise √† jour connue
            if (timestamp > lastKnownUpdate) {
                console.log('üîÑ Nouvelles donn√©es disponibles, mise √† jour...');
                
                // Mettre √† jour notre timestamp
                lastKnownUpdate = timestamp;
                
                // Charger les donn√©es
                const data = localStorage.getItem(DATA_KEY);
                if (data) {
                    try {
                        // Mise √† jour des donn√©es globales
                        window.refineries = JSON.parse(data);
                        
                        // Mettre √† jour l'affichage
                        displayRefineries();
                        showSyncIndicator();
                    } catch (parseError) {
                        console.error('‚ùå Erreur lors du parsing des donn√©es:', parseError);
                    }
                }
            }
        } catch (error) {
            console.error('‚ùå Erreur lors de la synchronisation:', error);
        } finally {
            isSyncActive = false;
        }
    }
    
    // Fonction pour signaler une mise √† jour des donn√©es
    function signalDataChange() {
        try {
            // Enregistrer le timestamp de la mise √† jour
            lastKnownUpdate = Date.now();
            localStorage.setItem(SYNC_KEY, lastKnownUpdate.toString());
            showSyncIndicator();
        } catch (error) {
            console.error('‚ùå Erreur lors de la signalisation des changements:', error);
        }
    }
    
    // Afficher l'indicateur de synchronisation
    function showSyncIndicator() {
        const indicator = document.querySelector('.sync-indicator');
        if (indicator) {
            indicator.style.display = 'flex';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
    }

    // ===== VARIABLES GLOBALES =====
    let allData = null;
    let refineries = [];
    let currentId = null;
    const STATUS_COLORS = {
        "Op√©rationnel": "#00AA00",
        "En construction": "#0000FF",
        "Planifi√©": "#FFA500",
        "Approuv√©": "#FFA500",
        "En suspens": "#FF0000",
        "En pause": "#FF0000"
    };
    
    // ===== INITIALISATION DE LA PAGE =====
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Page charg√©e, initialisation...');
        
        // V√©rifier l'authentification
        protectAdminPage();
        initLoginForm();
        
        // Initialiser les composants de l'interface
        initTabs();
        initButtons();
        
        // Charger les donn√©es
        loadData();
        
        // Configurer la synchronisation
        window.addEventListener('storage', function(event) {
            if (event.key === SYNC_KEY || event.key === DATA_KEY) {
                syncData();
            }
        });
        
        // V√©rifier les mises √† jour p√©riodiquement
        setInterval(syncData, 2000);
    });
    
    // Initialiser les onglets
    function initTabs() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // D√©sactiver tous les onglets
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activer l'onglet cliqu√©
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
    }
    
    // Initialiser les boutons
    function initButtons() {
        // Onglet Tableau
        document.getElementById('refresh-btn').addEventListener('click', loadData);
        document.getElementById('save-changes-btn').addEventListener('click', saveAllChanges);
        document.getElementById('increment-version-btn').addEventListener('click', incrementVersion);
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('add-installation-btn').addEventListener('click', addRefinery);
        
        // Import de fichier
        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });
        document.getElementById('import-file').addEventListener('change', importFile);
        
        // Upload GitHub
        document.getElementById('upload-github-btn').addEventListener('click', showGitHubModal);
        document.getElementById('github-upload').addEventListener('click', uploadToGitHub);
        document.getElementById('github-cancel').addEventListener('click', () => {
            document.getElementById('github-modal').style.display = 'none';
        });
        document.getElementById('github-modal-close').addEventListener('click', () => {
            document.getElementById('github-modal').style.display = 'none';
        });
        
        // Onglet √âditeur
        document.getElementById('validate-btn').addEventListener('click', validateJson);
        document.getElementById('apply-btn').addEventListener('click', applyJsonChanges);
        document.getElementById('download-btn').addEventListener('click', downloadJson);
        document.getElementById('reload-btn').addEventListener('click', reloadJson);
        
        // Filtres
        document.getElementById('country-filter').addEventListener('change', filterRefineries);
        document.getElementById('status-filter').addEventListener('change', filterRefineries);
        document.getElementById('search-filter').addEventListener('input', filterRefineries);
        
        // Modal d'√©dition
        document.getElementById('edit-form').addEventListener('submit', saveRefineryChanges);
        document.getElementById('edit-cancel').addEventListener('click', () => {
            document.getElementById('edit-modal').style.display = 'none';
        });
        document.getElementById('edit-modal-close').addEventListener('click', () => {
            document.getElementById('edit-modal').style.display = 'none';
        });
        
        // Modal de suppression
        document.getElementById('delete-confirm').addEventListener('click', confirmDelete);
        document.getElementById('delete-cancel').addEventListener('click', () => {
            document.getElementById('delete-modal').style.display = 'none';
        });
        
        // Fermer les modals en cliquant √† l'ext√©rieur
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    }
    
    // ===== GESTION DES DONN√âES =====
    // Charger les donn√©es
    async function loadData() {
        showNotification('table-notification', 'Chargement des donn√©es...', 'info');
        
        try {
            // Ajouter un param√®tre pour √©viter le cache
            const response = await fetch('data/refineries.json?t=' + Date.now());
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Donn√©es charg√©es:', data);
            
            if (!data.refineries || !Array.isArray(data.refineries)) {
                throw new Error('Format de donn√©es invalide: refineries manquantes ou non valides');
            }
            
            // Stocker les donn√©es
            allData = data;
            refineries = data.refineries;
            
            // Sauvegarder dans localStorage pour la synchronisation
            localStorage.setItem(DATA_KEY, JSON.stringify(refineries));
            
            // Mettre √† jour les informations de version
            document.getElementById('tableVersionInfo').textContent = `Version: ${data.version || 'non d√©finie'}`;
            document.getElementById('editorVersionInfo').textContent = `Version: ${data.version || 'non d√©finie'}`;
            
            // Afficher les donn√©es dans le tableau
            displayRefineries();
            
            // Charger dans l'√©diteur JSON
            document.getElementById('json-editor').value = JSON.stringify(data, null, 2);
            
            showNotification('table-notification', 'Donn√©es charg√©es avec succ√®s!', 'success');
            return true;
        } catch (error) {
            console.error('Erreur lors du chargement des donn√©es:', error);
            showNotification('table-notification', `Erreur: ${error.message}. Essayez d'importer un fichier JSON.`, 'error');
            
            // Essayer de charger des donn√©es de secours
            try {
                const backupData = {
                    version: "backup-" + new Date().toISOString().slice(0, 10),
                    refineries: [
                        {
                            "id": 1,
                            "name": "Example Refinery",
                            "location": "Example Location",
                            "country": "Canada",
                            "coordinates": [45.5017, -73.5673],
                            "status": "Op√©rationnel",
                            "production": "Example Production",
                            "processing": "Example Processing",
                            "notes": "Exemple de donn√©es de secours",
                            "website": "https://example.com"
                        }
                    ],
                    status_colors: STATUS_COLORS
                };
                
                allData = backupData;
                refineries = backupData.refineries;
                
                // Afficher les donn√©es dans le tableau
                displayRefineries();
                
                // Charger dans l'√©diteur JSON
                document.getElementById('json-editor').value = JSON.stringify(backupData, null, 2);
                
                showNotification('table-notification', 'Donn√©es de secours charg√©es. Importez un fichier JSON valide pour restaurer vos donn√©es.', 'warning');
                return true;
            } catch (backupError) {
                console.error('Erreur lors du chargement des donn√©es de secours:', backupError);
                return false;
            }
        }
    }
    
    // Afficher les raffineries dans le tableau
    function displayRefineries() {
        const tableBody = document.getElementById('refineries-table-body');
        tableBody.innerHTML = '';
        
        // Filtrer les donn√©es selon les crit√®res actuels
        const filteredRefineries = filterRefineries();
        
        if (filteredRefineries.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 15px;">Aucune installation trouv√©e</td></tr>';
            return;
        }
        
        // Tri par ID
        filteredRefineries.sort((a, b) => a.id - b.id);
        
        // Ajouter chaque raffinerie au tableau
        filteredRefineries.forEach(refinery => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${refinery.id || '-'}</td>
                <td>${refinery.name || '-'}</td>
                <td>${refinery.location || '-'}</td>
                <td>${refinery.country || '-'}</td>
                <td style="color: ${STATUS_COLORS[refinery.status] || '#000'}">${refinery.status || '-'}</td>
                <td>${refinery.production || '-'}</td>
                <td>${refinery.processing || '-'}</td>
                <td class="action-buttons">
                    <button onclick="editRefinery(${refinery.id})" class="edit-btn">Modifier</button>
                    <button onclick="deleteRefinery(${refinery.id})" class="danger">Supprimer</button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Filtrer les raffineries selon les crit√®res
    function filterRefineries() {
        // Si appel√© comme gestionnaire d'√©v√©nement, mettre √† jour l'affichage
        if (event && event.type) {
            displayRefineries();
            return;
        }
        
        // Si appel√© comme fonction, retourner les r√©sultats filtr√©s
        const countryFilter = document.getElementById('country-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        const searchFilter = document.getElementById('search-filter').value.toLowerCase();
        
        return refineries.filter(refinery => {
            // Filtre par pays
            if (countryFilter !== 'all' && refinery.country !== countryFilter) {
                return false;
            }
            
            // Filtre par statut
            if (statusFilter !== 'all' && refinery.status !== statusFilter) {
                return false;
            }
            
            // Filtre par recherche
            if (searchFilter) {
                const name = (refinery.name || '').toLowerCase();
                const location = (refinery.location || '').toLowerCase();
                const country = (refinery.country || '').toLowerCase();
                const status = (refinery.status || '').toLowerCase();
                const production = (refinery.production || '').toLowerCase();
                const processing = (refinery.processing || '').toLowerCase();
                
                return name.includes(searchFilter) || 
                       location.includes(searchFilter) || 
                       country.includes(searchFilter) || 
                       status.includes(searchFilter) || 
                       production.includes(searchFilter) || 
                       processing.includes(searchFilter);
            }
            
            return true;
        });
    }
    
    // ===== OP√âRATIONS SUR LES INSTALLATIONS =====
    // Ajouter une nouvelle installation
    function addRefinery() {
        currentId = null;
        
        // Remplir le formulaire avec des valeurs par d√©faut
        document.getElementById('edit-modal-title').textContent = 'Ajouter une installation';
        document.getElementById('edit-id').value = '';
        document.getElementById('edit-name').value = '';
        document.getElementById('edit-location').value = '';
        document.getElementById('edit-country').value = 'Canada';
        document.getElementById('edit-coordinates').value = '';
        document.getElementById('edit-status').value = 'Planifi√©';
        document.getElementById('edit-production').value = '';
        document.getElementById('edit-processing').value = '';
        document.getElementById('edit-notes').value = '';
        document.getElementById('edit-website').value = '';
        
        // Afficher la modal
        document.getElementById('edit-modal').style.display = 'block';
    }
    
    // Modifier une installation existante
    function editRefinery(id) {
        currentId = id;
        
        // Trouver l'installation √† modifier
        const refinery = refineries.find(r => r.id === id);
        if (!refinery) {
            showNotification('table-notification', `Installation avec ID ${id} non trouv√©e.`, 'error');
            return;
        }
        
        // Remplir le formulaire avec les valeurs existantes
        document.getElementById('edit-modal-title').textContent = 'Modifier une installation';
        document.getElementById('edit-id').value = refinery.id;
        document.getElementById('edit-name').value = refinery.name || '';
        document.getElementById('edit-location').value = refinery.location || '';
        document.getElementById('edit-country').value = refinery.country || 'Canada';
        document.getElementById('edit-coordinates').value = refinery.coordinates ? refinery.coordinates.join(', ') : '';
        document.getElementById('edit-status').value = refinery.status || 'Planifi√©';
        document.getElementById('edit-production').value = refinery.production || '';
        document.getElementById('edit-processing').value = refinery.processing || '';
        document.getElementById('edit-notes').value = refinery.notes || '';
        document.getElementById('edit-website').value = refinery.website || '';
        
        // Afficher la modal
        document.getElementById('edit-modal').style.display = 'block';
    }
    
    // Supprimer une installation
    function deleteRefinery(id) {
        // Trouver l'installation √† supprimer
        const refinery = refineries.find(r => r.id === id);
        if (!refinery) {
            showNotification('table-notification', `Installation avec ID ${id} non trouv√©e.`, 'error');
            return;
        }
        
        // Remplir la modal de confirmation
        document.getElementById('delete-refinery-name').textContent = refinery.name;
        document.getElementById('delete-id').value = id;
        
        // Afficher la modal
        document.getElementById('delete-modal').style.display = 'block';
    }
    
    // Confirmer la suppression
    function confirmDelete() {
        const id = parseInt(document.getElementById('delete-id').value);
        
        // Trouver l'index de l'installation √† supprimer
        const index = refineries.findIndex(r => r.id === id);
        if (index === -1) {
            showNotification('table-notification', `Installation avec ID ${id} non trouv√©e.`, 'error');
            return;
        }
        
        // Supprimer l'installation
        refineries.splice(index, 1);
        
        // Mettre √† jour l'affichage
        displayRefineries();
        
        // Mettre √† jour l'√©diteur JSON
        if (allData) {
            allData.refineries = refineries;
            document.getElementById('json-editor').value = JSON.stringify(allData, null, 2);
        }
        
        // Mettre √† jour localStorage et signaler le changement
        localStorage.setItem(DATA_KEY, JSON.stringify(refineries));
        signalDataChange();
        
        // Fermer la modal
        document.getElementById('delete-modal').style.display = 'none';
        
        showNotification('table-notification', 'Installation supprim√©e avec succ√®s.', 'success');
    }
    
    // Sauvegarder les modifications d'une installation
    function saveRefineryChanges(event) {
        event.preventDefault();
        
        // R√©cup√©rer les valeurs du formulaire
        const idValue = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value;
        const location = document.getElementById('edit-location').value;
        const country = document.getElementById('edit-country').value;
        const coordinatesStr = document.getElementById('edit-coordinates').value;
        const status = document.getElementById('edit-status').value;
        const production = document.getElementById('edit-production').value || 'N/A';
        const processing = document.getElementById('edit-processing').value || 'N/A';
        const notes = document.getElementById('edit-notes').value;
        const website = document.getElementById('edit-website').value || '#';
        
        // Traiter les coordonn√©es
        let coordinates = [0, 0];
        if (coordinatesStr) {
            const parts = coordinatesStr.split(',').map(part => parseFloat(part.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                coordinates = parts;
            }
        }
        
        if (idValue) {
            // Modification d'une installation existante
            const id = parseInt(idValue);
            const index = refineries.findIndex(r => r.id === id);
            
            if (index === -1) {
                showNotification('table-notification', `Installation avec ID ${id} non trouv√©e.`, 'error');
                return;
            }
            
            refineries[index] = {
                ...refineries[index],
                name,
                location,
                country,
                coordinates,
                status,
                production,
                processing,
                notes,
                website
            };
            
            showNotification('table-notification', 'Installation modifi√©e avec succ√®s.', 'success');
        } else {
            // Ajout d'une nouvelle installation
            const newId = Math.max(0, ...refineries.map(r => r.id)) + 1;
            
            refineries.push({
                id: newId,
                name,
                location,
                country,
                coordinates,
                status,
                production,
                processing,
                notes,
                website
            });
            
            showNotification('table-notification', 'Installation ajout√©e avec succ√®s.', 'success');
        }
        
        // Mettre √† jour l'affichage
        displayRefineries();
        
        // Mettre √† jour l'√©diteur JSON
        if (allData) {
            allData.refineries = refineries;
            document.getElementById('json-editor').value = JSON.stringify(allData, null, 2);
        }
        
        // Mettre √† jour localStorage et signaler le changement
        localStorage.setItem(DATA_KEY, JSON.stringify(refineries));
        signalDataChange();
        
        // Fermer la modal
        document.getElementById('edit-modal').style.display = 'none';
    }
    
    // ===== OP√âRATIONS SUR LES DONN√âES =====
    // Sauvegarder toutes les modifications
    function saveAllChanges() {
        try {
            // V√©rifier si les donn√©es sont valides
            if (!allData || !Array.isArray(refineries)) {
                showNotification('table-notification', 'Donn√©es non valides pour la sauvegarde.', 'error');
                return;
            }
            
            // Mettre √† jour les donn√©es
            allData.refineries = refineries;
            
            // V√©rifier si la version est d√©finie
            if (!allData.version) {
                allData.version = new Date().toISOString().slice(0, 10);
            }
            
            // V√©rifier si les couleurs de statut sont d√©finies
            if (!allData.status_colors) {
                allData.status_colors = STATUS_COLORS;
            }
            
            // Convertir en JSON et t√©l√©charger
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'refineries.json';
            link.click();
            
            // Mettre √† jour localStorage et signaler le changement
            localStorage.setItem(DATA_KEY, JSON.stringify(refineries));
            signalDataChange();
            
            showNotification('table-notification', 'Donn√©es sauvegard√©es avec succ√®s! T√©l√©chargement du fichier refineries.json termin√©.', 'success');
        } catch (error) {
            console.error('Erreur lors de la sauvegarde:', error);
            showNotification('table-notification', `Erreur lors de la sauvegarde: ${error.message}`, 'error');
        }
    }
    
    // Incr√©menter la version
    function incrementVersion() {
        try {
            if (!allData) {
                showNotification('table-notification', 'Donn√©es non disponibles pour l\'incr√©mentation de version.', 'error');
                return;
            }
            
            const currentDate = new Date();
            const formattedDate = currentDate.toISOString().slice(0, 10);
            
            // V√©rifier si la date est la m√™me que celle de la version actuelle
            const currentVersion = allData.version || '';
            let newVersion;
            
            if (currentVersion.startsWith(formattedDate)) {
                // Incr√©menter la version pour la m√™me date
                const versionParts = currentVersion.split('-v');
                const versionNumber = versionParts.length > 1 ? parseInt(versionParts[1]) || 0 : 0;
                newVersion = `${formattedDate}-v${versionNumber + 1}`;
            } else {
                // Nouvelle date, commencer √† v1
                newVersion = `${formattedDate}-v1`;
            }
            
            // Mettre √† jour la version
            allData.version = newVersion;
            
            // Mettre √† jour les affichages
            document.getElementById('tableVersionInfo').textContent = `Version: ${newVersion}`;
            document.getElementById('editorVersionInfo').textContent = `Version: ${newVersion}`;
            
            // Mettre √† jour l'√©diteur JSON
            document.getElementById('json-editor').value = JSON.stringify(allData, null, 2);
            
            showNotification('table-notification', `Version incr√©ment√©e √† ${newVersion}`, 'success');
        } catch (error) {
            console.error('Erreur lors de l\'incr√©mentation de la version:', error);
            showNotification('table-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Exporter les donn√©es
    function exportData() {
        try {
            // V√©rifier si les donn√©es sont valides
            if (!allData) {
                showNotification('table-notification', 'Donn√©es non disponibles pour l\'exportation.', 'error');
                return;
            }
            
            // Convertir en JSON et t√©l√©charger
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `recyclage_batteries_ve_${timestamp}.json`;
            link.click();
            
            showNotification('table-notification', 'Donn√©es export√©es avec succ√®s!', 'success');
        } catch (error) {
            console.error('Erreur lors de l\'exportation:', error);
            showNotification('table-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Importer un fichier JSON
    function importFile(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // V√©rifier si le format est correct
                if (!data.refineries || !Array.isArray(data.refineries)) {
                    throw new Error('Format de fichier invalide: refineries manquantes ou non valides');
                }
                
                // Mettre √† jour les donn√©es
                allData = data;
                refineries = data.refineries;
                
                // Mettre √† jour les informations de version
                const version = data.version || new Date().toISOString().slice(0, 10);
                document.getElementById('tableVersionInfo').textContent = `Version: ${version}`;
                document.getElementById('editorVersionInfo').textContent = `Version: ${version}`;
                
                // Mettre √† jour l'affichage
                displayRefineries();
                
                // Mettre √† jour l'√©diteur JSON
                document.getElementById('json-editor').value = JSON.stringify(data, null, 2);
                
                // Mettre √† jour localStorage et signaler le changement
                localStorage.setItem(DATA_KEY, JSON.stringify(refineries));
                signalDataChange();
                
                showNotification('table-notification', 'Fichier import√© avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur lors de l\'importation:', error);
                showNotification('table-notification', `Erreur: ${error.message}`, 'error');
            }
        };
        reader.readAsText(file);
        
        // R√©initialiser l'input file pour permettre une nouvelle importation du m√™me fichier
        event.target.value = '';
    }
    
    // ===== √âDITEUR JSON =====
    // Valider le JSON dans l'√©diteur
    function validateJson() {
        const jsonText = document.getElementById('json-editor').value;
        const validatorElement = document.getElementById('json-validator');
        
        try {
            const data = JSON.parse(jsonText);
            
            // V√©rifier si le format est correct
            if (!data.refineries || !Array.isArray(data.refineries)) {
                throw new Error('Format de donn√©es invalide: refineries manquantes ou non valides');
            }
            
            validatorElement.textContent = 'JSON valide!';
            validatorElement.style.color = '#27ae60';
            
            // Activer le bouton d'application
            document.getElementById('apply-btn').disabled = false;
            
            showNotification('editor-notification', 'JSON valide!', 'success');
        } catch (error) {
            validatorElement.textContent = `Erreur: ${error.message}`;
            validatorElement.style.color = '#e74c3c';
            
            // D√©sactiver le bouton d'application
            document.getElementById('apply-btn').disabled = true;
            
            showNotification('editor-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Appliquer les modifications depuis l'√©diteur JSON
    function applyJsonChanges() {
        const jsonText = document.getElementById('json-editor').value;
        
        try {
            const data = JSON.parse(jsonText);
            
            // V√©rifier si le format est correct
            if (!data.refineries || !Array.isArray(data.refineries)) {
                throw new Error('Format de donn√©es invalide: refineries manquantes ou non valides');
            }
            
            // Mettre √† jour les donn√©es
            allData = data;
            refineries = data.refineries;
            
            // Mettre √† jour les informations de version
            const version = data.version || 'non d√©finie';
            document.getElementById('tableVersionInfo').textContent = `Version: ${version}`;
            document.getElementById('editorVersionInfo').textContent = `Version: ${version}`;
            
            // Mettre √† jour l'affichage
            displayRefineries();
            
            // Mettre √† jour localStorage et signaler le changement
            localStorage.setItem(DATA_KEY, JSON.stringify(refineries));
            signalDataChange();
            
            showNotification('editor-notification', 'Modifications appliqu√©es avec succ√®s!', 'success');
        } catch (error) {
            console.error('Erreur lors de l\'application des modifications:', error);
            showNotification('editor-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // T√©l√©charger le JSON depuis l'√©diteur
    function downloadJson() {
        const jsonText = document.getElementById('json-editor').value;
        
        try {
            // V√©rifier si le JSON est valide
            JSON.parse(jsonText);
            
            // T√©l√©charger le fichier
            const dataBlob = new Blob([jsonText], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `refineries_${timestamp}.json`;
            link.click();
            
            showNotification('editor-notification', 'JSON t√©l√©charg√© avec succ√®s!', 'success');
        } catch (error) {
            console.error('Erreur lors du t√©l√©chargement du JSON:', error);
            showNotification('editor-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Recharger le JSON depuis le fichier
    function reloadJson() {
        try {
            // Recharger les donn√©es
            loadData().then(success => {
                if (success) {
                    showNotification('editor-notification', 'JSON recharg√© avec succ√®s depuis le fichier!', 'success');
                }
            });
        } catch (error) {
            console.error('Erreur lors du rechargement du JSON:', error);
            showNotification('editor-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // ===== GITHUB =====
    // Afficher la modal GitHub
    function showGitHubModal() {
        document.getElementById('github-modal').style.display = 'block';
        document.getElementById('github-message').value = `Mise √† jour des donn√©es d'installations - ${new Date().toISOString().slice(0, 10)}`;
    }
    
    // Upload vers GitHub
    async function uploadToGitHub() {
        const token = document.getElementById('github-token').value;
        const commitMessage = document.getElementById('github-message').value || `Mise √† jour des donn√©es - ${new Date().toISOString().slice(0, 10)}`;
        
        if (!token) {
            showNotification('table-notification', 'Token GitHub requis pour l\'upload.', 'error');
            return;
        }
        
        try {
            // V√©rifier si les donn√©es sont valides
            if (!allData) {
                showNotification('table-notification', 'Donn√©es non disponibles pour l\'upload.', 'error');
                return;
            }
            
            // Pr√©parer les donn√©es
            const jsonContent = JSON.stringify(allData, null, 2);
            
            // Obtenir le SHA du fichier existant si disponible
            let fileSha = "";
            try {
                const repoInfoResponse = await fetch('https://api.github.com/repos/tofunori/Lithium-Dashboard/contents/data/refineries.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (repoInfoResponse.ok) {
                    const repoInfo = await repoInfoResponse.json();
                    fileSha = repoInfo.sha;
                }
            } catch (error) {
                console.warn('Impossible d\'obtenir le SHA du fichier existant:', error);
            }
            
            // Encoder le contenu en base64
            const base64Content = btoa(unescape(encodeURIComponent(jsonContent)));
            
            // Pr√©parer la requ√™te
            const requestBody = {
                message: commitMessage,
                content: base64Content,
                branch: 'main'
            };
            
            if (fileSha) {
                requestBody.sha = fileSha;
            }
            
            // Effectuer la requ√™te
            const response = await fetch('https://api.github.com/repos/tofunori/Lithium-Dashboard/contents/data/refineries.json', {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Erreur GitHub (${response.status}): ${errorData.message}`);
            }
            
            const result = await response.json();
            
            // Fermer la modal
            document.getElementById('github-modal').style.display = 'none';
            
            showNotification('table-notification', 'Fichier upload√© avec succ√®s vers GitHub!', 'success');
        } catch (error) {
            console.error('Erreur lors de l\'upload vers GitHub:', error);
            showNotification('table-notification', `Erreur lors de l'upload: ${error.message}`, 'error');
        }
    }
    
    // ===== UTILITAIRES =====
    // Afficher une notification
    function showNotification(elementId, message, type) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`√âl√©ment de notification '${elementId}' non trouv√©!`);
            return;
        }
        
        // D√©finir le type de notification
        element.className = `notification ${type}`;
        element.textContent = message;
        element.style.display = 'block';
        
        // Masquer la notification apr√®s 5 secondes
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }
    
    // Rendre les fonctions disponibles globalement
    window.editRefinery = editRefinery;
    window.deleteRefinery = deleteRefinery;
    </script>
</body>
</html>