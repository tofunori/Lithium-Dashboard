<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Dashboard Recyclage de Batteries VE</title>
    
    <!-- Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        header {
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .panel {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn-group {
            margin: 20px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.success {
            background: #2ecc71;
        }
        button.success:hover {
            background: #27ae60;
        }
        textarea {
            width: 100%;
            min-height: 500px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .panel h2 {
            margin-top: 0;
        }
        .notification {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            display: none;
        }
        .notification.success {
            background: #d5f5e3;
            border: 1px solid #2ecc71;
            color: #27ae60;
        }
        .notification.error {
            background: #f5d5d5;
            border: 1px solid #e74c3c;
            color: #c0392b;
        }
        .notification.info {
            background: #d9edf7;
            border: 1px solid #3498db;
            color: #2980b9;
        }
        .notification.warning {
            background: #fcf8e3;
            border: 1px solid #f39c12;
            color: #e67e22;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .version-info {
            font-size: 14px;
            color: #777;
        }
        #jsonValidator {
            margin-top: 20px;
            color: #e74c3c;
        }
        .github-upload {
            background-color: #6e5494 !important;
        }
        .github-upload:hover {
            background-color: #583d7e !important;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #f2f2f2;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        .data-table .action-buttons {
            white-space: nowrap;
        }
        .data-table .action-buttons button {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 12px;
        }
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filter-bar select, .filter-bar input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .filter-bar label {
            margin-right: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #333;
        }
        /* Modal de login */
        #login-modal {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        .login-modal-content {
            background-color: white;
            border-radius: 5px;
            width: 400px;
            padding: 20px;
            max-width: 90%;
        }
        .login-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .login-modal-body form {
            display: flex;
            flex-direction: column;
        }
        .login-modal-body input {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .login-modal-body button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .login-modal-body button:hover {
            background: #2980b9;
        }
        #login-message {
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        /* Bouton de déconnexion */
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            float: right;
            margin-top: 10px;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        /* Indicateur de synchronisation */
        .sync-indicator {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            align-items: center;
        }
        .sync-indicator .dot {
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { background-color: #4CAF50; }
            50% { background-color: #FFC107; }
            100% { background-color: #4CAF50; }
        }
        
        /* Styles pour le debugging */
        .debug-panel {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background-color: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow: auto;
            z-index: 9999;
            display: none; /* Caché par défaut */
        }
    </style>
</head>
<body>
    <!-- Modal de connexion -->
    <div id="login-modal" class="modal">
        <div class="login-modal-content">
            <div class="login-modal-header">
                <h3>Connexion à l'administration</h3>
                <span class="close login-modal-close">&times;</span>
            </div>
            <div class="login-modal-body">
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="Nom d'utilisateur" required>
                    <input type="password" id="login-password" placeholder="Mot de passe" required>
                    <button type="submit">Se connecter</button>
                </form>
                <p id="login-message"></p>
            </div>
        </div>
    </div>

    <!-- Panel de debugging (caché par défaut) -->
    <div id="debug-panel" class="debug-panel"></div>

    <header>
        <button id="logout-btn" class="logout-btn" onclick="logout()">Déconnexion</button>
        <h1>Administration - Dashboard Recyclage de Batteries VE</h1>
        <p>Utilisez cet outil pour mettre à jour les données des installations de recyclage.</p>
        <a href="index.html" target="_blank" style="display: inline-block; margin-top: 10px; color: #3498db;">Voir le dashboard</a>
    </header>
    
    <div class="tabs">
        <div class="tab active" data-tab="table">Tableau des installations</div>
        <div class="tab" data-tab="editor">Éditeur JSON</div>
        <div class="tab" data-tab="help">Instructions</div>
    </div>
    
    <!-- Tableau des installations -->
    <div id="table-tab" class="tab-content active">
        <div class="panel">
            <div class="action-bar">
                <h2>Gestion des installations de recyclage</h2>
                <span class="version-info" id="tableVersionInfo">Version actuelle: -</span>
            </div>
            
            <div id="table-notification" class="notification"></div>
            
            <div class="filter-bar">
                <div>
                    <label for="country-filter">Pays:</label>
                    <select id="country-filter">
                        <option value="all">Tous</option>
                        <option value="Canada">Canada</option>
                        <option value="États-Unis">États-Unis</option>
                        <option value="Mexique">Mexique</option>
                    </select>
                </div>
                <div>
                    <label for="status-filter">Statut:</label>
                    <select id="status-filter">
                        <option value="all">Tous</option>
                        <option value="Opérationnel">Opérationnel</option>
                        <option value="En construction">En construction</option>
                        <option value="Planifié">Planifié</option>
                        <option value="Approuvé">Approuvé</option>
                        <option value="En pause">En pause</option>
                    </select>
                </div>
                <div>
                    <label for="search-filter">Recherche:</label>
                    <input type="text" id="search-filter" placeholder="Rechercher...">
                </div>
                <button id="add-installation-btn" class="success">Ajouter une installation</button>
            </div>
            
            <div class="table-container" style="overflow-x: auto;">
                <table id="refineries-table" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Emplacement</th>
                            <th>Pays</th>
                            <th>Statut</th>
                            <th>Production</th>
                            <th>Technologie</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="refineries-table-body">
                        <!-- Rempli dynamiquement par JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="btn-group">
                <button id="refresh-btn">Rafraîchir</button>
                <button id="save-changes-btn" class="success">Enregistrer les modifications</button>
                <button id="increment-version-btn">Incrémenter la version</button>
                <button id="export-btn">Exporter (JSON)</button>
                <button id="import-btn">Importer un fichier JSON</button>
                <button id="upload-github-btn" class="github-upload">Uploader vers GitHub</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>
        </div>
    </div>
    
    <!-- Éditeur JSON -->
    <div id="editor-tab" class="tab-content">
        <div class="panel">
            <div class="action-bar">
                <h2>Éditeur de données JSON</h2>
                <span class="version-info" id="editorVersionInfo">Version actuelle: -</span>
            </div>
            
            <div id="editor-notification" class="notification"></div>
            
            <p>Modifiez directement le JSON ci-dessous, puis cliquez sur "Valider" pour vérifier la syntaxe avant de sauvegarder.</p>
            
            <textarea id="json-editor"></textarea>
            
            <div id="json-validator"></div>
            
            <div class="btn-group">
                <button id="validate-btn">Valider le JSON</button>
                <button id="apply-btn" class="success" disabled>Appliquer les modifications</button>
                <button id="download-btn">Télécharger le JSON</button>
                <button id="reload-btn">Recharger depuis le fichier</button>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div id="help-tab" class="tab-content">
        <div class="panel">
            <h2>Instructions d'utilisation</h2>
            
            <h3>Fonctionnalités principales</h3>
            <ul>
                <li><strong>Tableau des installations</strong> - Vue complète des installations avec filtres et recherche</li>
                <li><strong>Éditeur JSON</strong> - Modification directe du JSON pour les utilisateurs avancés</li>
                <li><strong>Import/Export</strong> - Sauvegarde et restauration des données</li>
                <li><strong>Synchronisation automatique</strong> - Les changements sont répercutés automatiquement</li>
            </ul>
            
            <h3>Gestion des installations</h3>
            <ol>
                <li>Utilisez les <strong>filtres</strong> pour trouver rapidement des installations</li>
                <li>Cliquez sur <strong>Ajouter une installation</strong> pour créer une nouvelle entrée</li>
                <li>Utilisez les boutons <strong>Modifier</strong> et <strong>Supprimer</strong> pour gérer les installations existantes</li>
                <li>N'oubliez pas de cliquer sur <strong>Enregistrer les modifications</strong> pour sauvegarder les changements</li>
                <li>Utilisez <strong>Incrémenter la version</strong> pour forcer la mise à jour du dashboard pour tous les utilisateurs</li>
            </ol>
            
            <h3>En cas de problème</h3>
            <p>Si vous rencontrez des difficultés :</p>
            <ol>
                <li>Utilisez le bouton <strong>Rafraîchir</strong> pour recharger les données</li>
                <li>Essayez d'<strong>Importer un fichier JSON</strong> existant</li>
                <li>Vérifiez la structure de votre fichier JSON dans l'onglet Éditeur</li>
                <li>Effacez le cache de votre navigateur si les problèmes persistent</li>
            </ol>
            
            <h3>Création d'un token GitHub</h3>
            <p>Pour utiliser la fonctionnalité d'upload direct vers GitHub, vous devez disposer d'un token d'accès personnel :</p>
            <ol>
                <li>Allez sur <a href="https://github.com/settings/tokens" target="_blank">https://github.com/settings/tokens</a></li>
                <li>Cliquez sur "Generate new token" puis "Generate new token (classic)"</li>
                <li>Donnez un nom à votre token, par exemple "Dashboard Admin"</li>
                <li>Sélectionnez le scope "repo" pour avoir accès en écriture à vos dépôts</li>
                <li>Cliquez sur "Generate token"</li>
                <li>Copiez le token généré (vous ne pourrez plus le voir ensuite)</li>
            </ol>
            <p><strong>Note de sécurité :</strong> Ne partagez jamais votre token GitHub. Ce script ne stocke pas votre token mais l'utilise uniquement pour l'opération d'upload en cours.</p>
        </div>
    </div>
    
    <!-- Modal pour ajouter/modifier une installation -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="edit-modal-close">&times;</span>
            <h2 id="edit-modal-title">Ajouter/Modifier une installation</h2>
            
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label for="edit-name">Nom:</label>
                        <input type="text" id="edit-name" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                    </div>
                    <div>
                        <label for="edit-location">Emplacement:</label>
                        <input type="text" id="edit-location" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                    </div>
                    <div>
                        <label for="edit-country">Pays:</label>
                        <select id="edit-country" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                            <option value="Canada">Canada</option>
                            <option value="États-Unis">États-Unis</option>
                            <option value="Mexique">Mexique</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-coordinates">Coordonnées (lat, lng):</label>
                        <input type="text" id="edit-coordinates" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 45.5017, -73.5673">
                    </div>
                    <div>
                        <label for="edit-status">Statut:</label>
                        <select id="edit-status" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                            <option value="Opérationnel">Opérationnel</option>
                            <option value="En construction">En construction</option>
                            <option value="Planifié">Planifié</option>
                            <option value="Approuvé">Approuvé</option>
                            <option value="En pause">En pause</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-production">Production/Capacité:</label>
                        <input type="text" id="edit-production" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: 10 000 tonnes par an">
                    </div>
                    <div>
                        <label for="edit-processing">Technologie:</label>
                        <input type="text" id="edit-processing" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: Hydrométallurgie">
                    </div>
                    <div>
                        <label for="edit-website">Site web:</label>
                        <input type="url" id="edit-website" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ex: https://example.com">
                    </div>
                </div>
                
                <div>
                    <label for="edit-notes">Notes:</label>
                    <textarea id="edit-notes" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; min-height: 100px;"></textarea>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" id="edit-cancel" class="danger">Annuler</button>
                    <button type="submit" id="edit-save" class="success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de confirmation pour la suppression -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h2>Confirmer la suppression</h2>
            <p>Êtes-vous sûr de vouloir supprimer cette installation? Cette action est irréversible.</p>
            <p><strong id="delete-refinery-name"></strong></p>
            <div style="margin-top: 20px; text-align: right;">
                <button id="delete-cancel" style="background-color: #ccc; color: #333;">Annuler</button>
                <button id="delete-confirm" class="danger">Supprimer</button>
            </div>
            <input type="hidden" id="delete-id">
        </div>
    </div>
    
    <!-- Modal pour GitHub upload -->
    <div id="github-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="github-modal-close">&times;</span>
            <h2>Upload vers GitHub</h2>
            <div style="margin-bottom: 15px;">
                <label for="github-token">Token GitHub:</label>
                <input type="password" id="github-token" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="ghp_votre_token_personnel">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="github-message">Message de commit:</label>
                <input type="text" id="github-message" style="width: 100%; padding: 8px; margin-top: 5px;" placeholder="Mise à jour des données d'installations">
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="github-cancel" style="background-color: #ccc; color: #333;">Annuler</button>
                <button id="github-upload" class="github-upload">Uploader</button>
            </div>
        </div>
    </div>
    
    <!-- Indicateur de synchronisation -->
    <div class="sync-indicator">
        <div class="dot"></div>
        <span>Synchronisation active</span>
    </div>

    <!-- Scripts intégrés pour éviter les problèmes de chargement -->
    <script>
    // Constants for storage
    const DASHBOARD_DATA_KEY = 'lithium_dashboard_data';
    const DASHBOARD_VERSION_KEY = 'lithium_dashboard_version';
    
    // Fonction pour le debugging - DÉSACTIVÉ
    const DEBUG = false; // Changé à false pour désactiver la fenêtre de debug
    function debug(message, obj) {
        if (!DEBUG) return;
        
        const panel = document.getElementById('debug-panel');
        if (!panel) return;
        
        // Afficher le panel
        panel.style.display = 'block';
        
        // Format du message
        const timestamp = new Date().toLocaleTimeString();
        let formattedMessage = `[${timestamp}] ${message}`;
        
        // Si un objet est fourni, l'afficher
        if (obj !== undefined) {
            try {
                const objString = typeof obj === 'object' ? JSON.stringify(obj, null, 2) : obj.toString();
                formattedMessage += '\n' + objString;
            } catch (e) {
                formattedMessage += '\n[Non affichable]';
            }
        }
        
        // Ajouter le message
        const msgElem = document.createElement('div');
        msgElem.textContent = formattedMessage;
        panel.appendChild(msgElem);
        
        // Limiter le nombre de messages
        while (panel.children.length > 20) {
            panel.removeChild(panel.firstChild);
        }
        
        // Scroll to bottom
        panel.scrollTop = panel.scrollHeight;
    }
    
    // ===== AUTHENTIFICATION =====
    const AUTH_KEY = 'lithium_dashboard_auth';
    const DEFAULT_CREDENTIALS = {
        username: 'admin',
        password: 'lithium2025'
    };
    
    // Vérifier si l'utilisateur est connecté
    function isLoggedIn() {
        return localStorage.getItem(AUTH_KEY) === 'true';
    }
    
    // Protéger la page
    function protectAdminPage() {
        if (!isLoggedIn()) {
            debug("Non authentifié, affichage du formulaire de connexion");
            document.getElementById('login-modal').style.display = 'flex';
        } else {
            debug("Authentifié, accès autorisé");
        }
    }
    
    // Fonction de connexion
    function login(username, password) {
        if (username === DEFAULT_CREDENTIALS.username && password === DEFAULT_CREDENTIALS.password) {
            localStorage.setItem(AUTH_KEY, 'true');
            return true;
        }
        return false;
    }
    
    // Fonction de déconnexion
    function logout() {
        localStorage.removeItem(AUTH_KEY);
        window.location.reload();
    }

    // ===== SYNCHRONISATION =====
    const SYNC_KEY = 'lithium_sync_timestamp';
    
    // Signaler un changement de données
    function signalChange() {
        const timestamp = Date.now();
        localStorage.setItem(SYNC_KEY, timestamp.toString());
        showSyncIndicator();
    }
    
    // Afficher l'indicateur de synchronisation
    function showSyncIndicator() {
        const indicator = document.querySelector('.sync-indicator');
        if (indicator) {
            indicator.style.display = 'flex';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
    }

    // ===== VARIABLES GLOBALES =====
    let allData = null;
    let refineries = [];
    let currentId = null;
    const STATUS_COLORS = {
        "Opérationnel": "#00AA00",
        "En construction": "#0000FF",
        "Planifié": "#FFA500",
        "Approuvé": "#FFA500",
        "En suspens": "#FF0000",
        "En pause": "#FF0000"
    };
    
    // Données par défaut (utilisées si aucune donnée n'est trouvée)
    const DEFAULT_DATA = {
        version: new Date().toISOString().slice(0, 10),
        refineries: [
            {
                "id": 1,
                "name": "Li-Cycle",
                "location": "Kingston, Ontario, Canada",
                "country": "Canada",
                "coordinates": [44.2312, -76.4860],
                "status": "Opérationnel",
                "production": "10 000+ tonnes de masse noire par an",
                "processing": "Spoke & Hub Technologies - Procédé hydrométallurgique",
                "notes": "Produit de la masse noire à partir de batteries lithium-ion usagées, hub aux États-Unis en pause.",
                "website": "https://li-cycle.com/"
            },
            {
                "id": 2,
                "name": "Lithion Technologies",
                "location": "Saint-Bruno-de-Montarville, Québec, Canada",
                "country": "Canada",
                "coordinates": [45.5366, -73.3718],
                "status": "Opérationnel",
                "production": "10 000-20 000 tonnes de batteries par an",
                "processing": "Procédé hydrométallurgique en deux étapes",
                "notes": "Produit de la masse noire, usine d'hydrométallurgie pour matériaux avancés prévue pour 2026.",
                "website": "https://www.lithiontechnologies.com/"
            }
        ],
        status_colors: STATUS_COLORS,
        chart_colors: ["#4a6bff", "#ff7043", "#ffca28", "#66bb6a", "#ab47bc"]
    };
    
    // Initialisation de la page
    document.addEventListener('DOMContentLoaded', () => {
        debug('Page chargée, initialisation...');
        
        // Protéger la page
        protectAdminPage();
        
        // Initialiser le formulaire de connexion
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                if (login(username, password)) {
                    document.getElementById('login-message').textContent = 'Connexion réussie';
                    document.getElementById('login-message').style.color = 'green';
                    setTimeout(() => {
                        document.getElementById('login-modal').style.display = 'none';
                        window.location.reload();
                    }, 1000);
                } else {
                    document.getElementById('login-message').textContent = 'Identifiants incorrects';
                    document.getElementById('login-message').style.color = 'red';
                }
            });
        }
        
        // Fermeture du modal de connexion
        const modalCloseBtn = document.querySelector('.login-modal-close');
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', function() {
                document.getElementById('login-modal').style.display = 'none';
            });
        }
        
        // Continuer l'initialisation seulement si connecté
        if (isLoggedIn()) {
            initTabs();
            initButtons();
            loadData();
        }
    });
    
    // Initialiser les onglets
    function initTabs() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Désactiver tous les onglets
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activer l'onglet cliqué
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
    }
    
    // Initialiser les boutons
    function initButtons() {
        // Onglet Tableau
        document.getElementById('refresh-btn').addEventListener('click', loadData);
        document.getElementById('save-changes-btn').addEventListener('click', saveAllChanges);
        document.getElementById('increment-version-btn').addEventListener('click', incrementVersion);
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('add-installation-btn').addEventListener('click', addRefinery);
        
        // Import de fichier
        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });
        document.getElementById('import-file').addEventListener('change', importFile);
        
        // Upload GitHub
        document.getElementById('upload-github-btn').addEventListener('click', showGitHubModal);
        
        // Onglet Éditeur
        document.getElementById('validate-btn').addEventListener('click', validateJson);
        document.getElementById('apply-btn').addEventListener('click', applyJsonChanges);
        document.getElementById('download-btn').addEventListener('click', downloadJson);
        document.getElementById('reload-btn').addEventListener('click', reloadJson);
        
        // Filtres
        document.getElementById('country-filter').addEventListener('change', filterRefineries);
        document.getElementById('status-filter').addEventListener('change', filterRefineries);
        document.getElementById('search-filter').addEventListener('input', filterRefineries);
        
        // Modal d'édition
        document.getElementById('edit-form').addEventListener('submit', saveRefineryChanges);
        document.getElementById('edit-cancel').addEventListener('click', () => {
            document.getElementById('edit-modal').style.display = 'none';
        });
        document.getElementById('edit-modal-close').addEventListener('click', () => {
            document.getElementById('edit-modal').style.display = 'none';
        });
        
        // Modal de suppression
        document.getElementById('delete-confirm').addEventListener('click', confirmDelete);
        document.getElementById('delete-cancel').addEventListener('click', () => {
            document.getElementById('delete-modal').style.display = 'none';
        });
        
        // Modal GitHub
        document.getElementById('github-upload').addEventListener('click', uploadToGitHub);
        document.getElementById('github-cancel').addEventListener('click', () => {
            document.getElementById('github-modal').style.display = 'none';
        });
        document.getElementById('github-modal-close').addEventListener('click', () => {
            document.getElementById('github-modal').style.display = 'none';
        });
        
        // Fermer les modals en cliquant à l'extérieur
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    }
    
    // Charger les données
    async function loadData() {
        showNotification('table-notification', 'Chargement des données...', 'info');
        debug('Chargement des données...');
        
        try {
            // D'abord vérifier si nous avons des données dans localStorage
            const savedData = localStorage.getItem(DASHBOARD_DATA_KEY);
            if (savedData) {
                try {
                    debug('Données trouvées dans localStorage');
                    const data = JSON.parse(savedData);
                    
                    // Vérifier si les données sont valides
                    if (data && data.refineries && Array.isArray(data.refineries)) {
                        allData = data;
                        refineries = data.refineries;
                        
                        // Mise à jour de l'interface
                        updateInterface();
                        
                        showNotification('table-notification', 'Données chargées depuis la base de données locale!', 'success');
                        return true;
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement des données locales:', error);
                    debug('Erreur lors du chargement des données locales', error);
                }
            }
            
            // Si pas de données locales, essayer de charger depuis le fichier
            try {
                // Ajouter un paramètre pour éviter le cache
                const response = await fetch('data/refineries.json?t=' + Date.now());
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                debug('Données chargées depuis le fichier JSON', data);
                
                if (!data.refineries || !Array.isArray(data.refineries)) {
                    throw new Error('Format de données invalide: refineries manquantes ou non valides');
                }
                
                // Stocker les données
                allData = data;
                refineries = data.refineries;
                
                // Mise à jour de l'interface
                updateInterface();
                
                // Sauvegarder dans localStorage pour les prochaines utilisations
                saveToLocalStorage();
                
                showNotification('table-notification', 'Données chargées avec succès!', 'success');
                return true;
            } catch (loadError) {
                console.error('Erreur lors du chargement du fichier:', loadError);
                debug('Erreur lors du chargement du fichier', loadError);
                
                // Si pas de données locales et pas de fichier, utiliser les données par défaut
                allData = DEFAULT_DATA;
                refineries = DEFAULT_DATA.refineries;
                
                // Mise à jour de l'interface
                updateInterface();
                
                // Sauvegarder dans localStorage
                saveToLocalStorage();
                
                showNotification('table-notification', 'Données par défaut chargées.', 'warning');
                return true;
            }
        } catch (error) {
            console.error('Erreur lors du chargement des données:', error);
            debug('Erreur lors du chargement des données', error);
            showNotification('table-notification', `Erreur: ${error.message}`, 'error');
            return false;
        }
    }
    
    // Mise à jour de l'interface après chargement des données
    function updateInterface() {
        debug('Mise à jour de l\'interface');
        
        // Mettre à jour les informations de version
        document.getElementById('tableVersionInfo').textContent = `Version: ${allData.version || 'non définie'}`;
        document.getElementById('editorVersionInfo').textContent = `Version: ${allData.version || 'non définie'}`;
        
        // Afficher les données dans le tableau
        displayRefineries();
        
        // Charger dans l'éditeur JSON
        document.getElementById('json-editor').value = JSON.stringify(allData, null, 2);
    }
    
    // Afficher les raffineries dans le tableau
    function displayRefineries() {
        debug('Affichage des installations...');
        const tableBody = document.getElementById('refineries-table-body');
        tableBody.innerHTML = '';
        
        // Vérifier si nous avons des données
        if (!refineries || refineries.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 15px;">Aucune installation trouvée</td></tr>';
            debug('Aucune installation disponible');
            return;
        }
        
        // Filtrer les données selon les critères actuels
        const filteredRefineries = getFilteredRefineries();
        
        if (filteredRefineries.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 15px;">Aucune installation trouvée avec ces critères</td></tr>';
            debug('Aucune installation trouvée après filtrage');
            return;
        }
        
        // Tri par ID
        filteredRefineries.sort((a, b) => a.id - b.id);
        
        // Ajouter chaque raffinerie au tableau
        filteredRefineries.forEach(refinery => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${refinery.id || '-'}</td>
                <td>${refinery.name || '-'}</td>
                <td>${refinery.location || '-'}</td>
                <td>${refinery.country || '-'}</td>
                <td style="color: ${STATUS_COLORS[refinery.status] || '#000'};">${refinery.status || '-'}</td>
                <td>${refinery.production || '-'}</td>
                <td>${refinery.processing || '-'}</td>
                <td class="action-buttons">
                    <button onclick="editRefinery(${refinery.id})" class="edit-btn">Modifier</button>
                    <button onclick="deleteRefinery(${refinery.id})" class="danger">Supprimer</button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        debug(`Affichage terminé: ${filteredRefineries.length} installations`);
    }
    
    // Obtenir les raffineries filtrées
    function getFilteredRefineries() {
        // Vérifier d'abord si refineries existe et a des éléments
        if (!refineries || refineries.length === 0) {
            return [];
        }
        
        const countryFilter = document.getElementById('country-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        const searchFilter = document.getElementById('search-filter').value.toLowerCase();
        
        debug(`Filtrage avec: pays=${countryFilter}, statut=${statusFilter}, recherche=${searchFilter}`);
        
        return refineries.filter(refinery => {
            // Filtre par pays
            if (countryFilter !== 'all' && refinery.country !== countryFilter) {
                return false;
            }
            
            // Filtre par statut
            if (statusFilter !== 'all' && refinery.status !== statusFilter) {
                return false;
            }
            
            // Filtre par recherche
            if (searchFilter) {
                const name = (refinery.name || '').toLowerCase();
                const location = (refinery.location || '').toLowerCase();
                const country = (refinery.country || '').toLowerCase();
                const status = (refinery.status || '').toLowerCase();
                const production = (refinery.production || '').toLowerCase();
                const processing = (refinery.processing || '').toLowerCase();
                
                return name.includes(searchFilter) || 
                       location.includes(searchFilter) || 
                       country.includes(searchFilter) || 
                       status.includes(searchFilter) || 
                       production.includes(searchFilter) || 
                       processing.includes(searchFilter);
            }
            
            return true;
        });
    }
    
    // Gestionnaire d'événement pour les filtres
    function filterRefineries() {
        displayRefineries();
    }
    
    // Ajouter une nouvelle installation
    function addRefinery() {
        debug('Ajout d\'une nouvelle installation');
        currentId = null;
        
        // Remplir le formulaire avec des valeurs par défaut
        document.getElementById('edit-modal-title').textContent = 'Ajouter une installation';
        document.getElementById('edit-id').value = '';
        document.getElementById('edit-name').value = '';
        document.getElementById('edit-location').value = '';
        document.getElementById('edit-country').value = 'Canada';
        document.getElementById('edit-coordinates').value = '';
        document.getElementById('edit-status').value = 'Planifié';
        document.getElementById('edit-production').value = '';
        document.getElementById('edit-processing').value = '';
        document.getElementById('edit-notes').value = '';
        document.getElementById('edit-website').value = '';
        
        // Afficher la modal
        document.getElementById('edit-modal').style.display = 'block';
    }
    
    // Modifier une installation existante
    function editRefinery(id) {
        debug(`Modification de l'installation ${id}`);
        currentId = id;
        
        // Trouver l'installation à modifier
        const refinery = refineries.find(r => r.id === id);
        if (!refinery) {
            showNotification('table-notification', `Installation avec ID ${id} non trouvée.`, 'error');
            debug(`Erreur: Installation avec ID ${id} non trouvée`);
            return;
        }
        
        debug('Installation trouvée pour modification', refinery);
        
        // Remplir le formulaire avec les valeurs existantes
        document.getElementById('edit-modal-title').textContent = 'Modifier une installation';
        document.getElementById('edit-id').value = refinery.id;
        document.getElementById('edit-name').value = refinery.name || '';
        document.getElementById('edit-location').value = refinery.location || '';
        document.getElementById('edit-country').value = refinery.country || 'Canada';
        document.getElementById('edit-coordinates').value = refinery.coordinates ? refinery.coordinates.join(', ') : '';
        document.getElementById('edit-status').value = refinery.status || 'Planifié';
        document.getElementById('edit-production').value = refinery.production || '';
        document.getElementById('edit-processing').value = refinery.processing || '';
        document.getElementById('edit-notes').value = refinery.notes || '';
        document.getElementById('edit-website').value = refinery.website || '';
        
        // Afficher la modal
        document.getElementById('edit-modal').style.display = 'block';
    }
    
    // Supprimer une installation
    function deleteRefinery(id) {
        debug(`Demande de suppression de l'installation ${id}`);
        
        // Trouver l'installation à supprimer
        const refinery = refineries.find(r => r.id === id);
        if (!refinery) {
            showNotification('table-notification', `Installation avec ID ${id} non trouvée.`, 'error');
            debug(`Erreur: Installation avec ID ${id} non trouvée`);
            return;
        }
        
        // Remplir la modal de confirmation
        document.getElementById('delete-refinery-name').textContent = refinery.name;
        document.getElementById('delete-id').value = id;
        
        // Afficher la modal
        document.getElementById('delete-modal').style.display = 'block';
    }
    
    // Confirmer la suppression
    function confirmDelete() {
        const id = parseInt(document.getElementById('delete-id').value);
        debug(`Confirmation de suppression de l'installation ${id}`);
        
        // Trouver l'index de l'installation à supprimer
        const index = refineries.findIndex(r => r.id === id);
        if (index === -1) {
            showNotification('table-notification', `Installation avec ID ${id} non trouvée.`, 'error');
            debug(`Erreur: Installation avec ID ${id} non trouvée`);
            return;
        }
        
        debug(`Suppression de l'installation à l'index ${index}`);
        
        // Vérification avant suppression
        debug('État des données avant suppression', {
            count: refineries.length,
            itemToRemove: refineries[index]
        });
        
        // Supprimer l'installation
        refineries.splice(index, 1);
        
        // Vérification après suppression
        debug('État des données après suppression', {
            count: refineries.length
        });
        
        // Mettre à jour l'affichage
        displayRefineries();
        
        // Mettre à jour l'éditeur JSON
        if (allData) {
            allData.refineries = refineries;
            document.getElementById('json-editor').value = JSON.stringify(allData, null, 2);
        }
        
        // Sauvegarder dans localStorage
        saveToLocalStorage();
        
        // Fermer la modal
        document.getElementById('delete-modal').style.display = 'none';
        
        showNotification('table-notification', 'Installation supprimée avec succès.', 'success');
    }
    
    // Sauvegarder dans localStorage
    function saveToLocalStorage() {
        debug('Sauvegarde des données dans localStorage');
        
        // Sauvegarder les données principales
        localStorage.setItem(DASHBOARD_DATA_KEY, JSON.stringify(allData));
        
        // Sauvegarder la version
        if (allData && allData.version) {
            localStorage.setItem(DASHBOARD_VERSION_KEY, allData.version);
        }
        
        // Signaler le changement
        signalChange();
    }
    
    // Sauvegarder les modifications d'une installation
    function saveRefineryChanges(event) {
        event.preventDefault();
        
        // Récupérer les valeurs du formulaire
        const idValue = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value;
        const location = document.getElementById('edit-location').value;
        const country = document.getElementById('edit-country').value;
        const coordinatesStr = document.getElementById('edit-coordinates').value;
        const status = document.getElementById('edit-status').value;
        const production = document.getElementById('edit-production').value || 'N/A';
        const processing = document.getElementById('edit-processing').value || 'N/A';
        const notes = document.getElementById('edit-notes').value;
        const website = document.getElementById('edit-website').value || '#';
        
        // Traiter les coordonnées
        let coordinates = [0, 0];
        if (coordinatesStr) {
            const parts = coordinatesStr.split(',').map(part => parseFloat(part.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                coordinates = parts;
            }
        }
        
        // Faire une copie des données avant modification pour debugging
        const dataBefore = JSON.parse(JSON.stringify(refineries));
        
        if (idValue) {
            // Modification d'une installation existante
            const id = parseInt(idValue);
            debug(`Sauvegarde des modifications pour l'installation ${id}`);
            
            const index = refineries.findIndex(r => r.id === id);
            
            if (index === -1) {
                showNotification('table-notification', `Installation avec ID ${id} non trouvée.`, 'error');
                debug(`Erreur: Installation avec ID ${id} non trouvée`);
                return;
            }
            
            // Garder une copie de l'installation originale pour debugging
            const originalRefinery = {...refineries[index]};
            
            // Important: Utiliser une approche qui préserve toutes les propriétés existantes
            // et modifie uniquement celles qui sont dans le formulaire
            refineries[index] = {
                ...refineries[index],
                name,
                location,
                country,
                coordinates,
                status,
                production,
                processing,
                notes,
                website
            };
            
            debug('Modification d\'installation', {
                original: originalRefinery,
                modified: refineries[index]
            });
            
            showNotification('table-notification', 'Installation modifiée avec succès.', 'success');
        } else {
            // Ajout d'une nouvelle installation
            debug('Ajout d\'une nouvelle installation');
            
            // Recherche du prochain ID disponible
            const newId = Math.max(0, ...refineries.map(r => r.id || 0)) + 1;
            
            // Création de la nouvelle installation
            const newRefinery = {
                id: newId,
                name,
                location,
                country,
                coordinates,
                status,
                production,
                processing,
                notes,
                website
            };
            
            refineries.push(newRefinery);
            debug('Nouvelle installation ajoutée', newRefinery);
            
            showNotification('table-notification', 'Installation ajoutée avec succès.', 'success');
        }
        
        // Vérification des données après modification
        debug('Comparaison avant/après', {
            countBefore: dataBefore.length,
            countAfter: refineries.length
        });
        
        // Mettre à jour l'affichage
        displayRefineries();
        
        // Mettre à jour l'éditeur JSON
        if (allData) {
            allData.refineries = refineries;
            document.getElementById('json-editor').value = JSON.stringify(allData, null, 2);
        }
        
        // Sauvegarder dans localStorage
        saveToLocalStorage();
        
        // Fermer la modal
        document.getElementById('edit-modal').style.display = 'none';
    }
    
    // Sauvegarder toutes les modifications
    function saveAllChanges() {
        try {
            debug('Sauvegarde de toutes les modifications...');
            
            // Vérifier si les données sont valides
            if (!allData || !Array.isArray(refineries)) {
                showNotification('table-notification', 'Données non valides pour la sauvegarde.', 'error');
                debug('Erreur: Données non valides pour la sauvegarde');
                return;
            }
            
            // Mettre à jour les données
            allData.refineries = refineries;
            
            // Vérifier si la version est définie
            if (!allData.version) {
                allData.version = new Date().toISOString().slice(0, 10);
            }
            
            // Vérifier si les couleurs de statut sont définies
            if (!allData.status_colors) {
                allData.status_colors = STATUS_COLORS;
            }
            
            // Convertir en JSON
            const dataStr = JSON.stringify(allData, null, 2);
            
            // Sauvegarder dans localStorage
            saveToLocalStorage();
            
            // Télécharger une copie de sauvegarde
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'refineries-backup.json';
            link.click();
            
            debug('Données sauvegardées avec succès');
            showNotification('table-notification', 'Données enregistrées avec succès! Votre dashboard est maintenant à jour.', 'success');
            
            // Force d'actualiser le dashboard s'il est ouvert dans d'autres onglets
            try {
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('force_dashboard_refresh', Date.now().toString());
                }
            } catch (e) {
                console.error('Erreur lors de la notification aux autres onglets:', e);
            }
            
        } catch (error) {
            console.error('Erreur lors de la sauvegarde:', error);
            debug('Erreur lors de la sauvegarde', error);
            showNotification('table-notification', `Erreur lors de la sauvegarde: ${error.message}`, 'error');
        }
    }
    
    // Incrémenter la version
    function incrementVersion() {
        try {
            debug('Incrémentation de la version...');
            
            if (!allData) {
                showNotification('table-notification', 'Données non disponibles pour l\'incrémentation de version.', 'error');
                debug('Erreur: Données non disponibles pour l\'incrémentation de version');
                return;
            }
            
            const currentDate = new Date();
            const formattedDate = currentDate.toISOString().slice(0, 10);
            
            // Vérifier si la date est la même que celle de la version actuelle
            const currentVersion = allData.version || '';
            let newVersion;
            
            if (currentVersion.startsWith(formattedDate)) {
                // Incrémenter la version pour la même date
                const versionParts = currentVersion.split('-v');
                const versionNumber = versionParts.length > 1 ? parseInt(versionParts[1]) || 0 : 0;
                newVersion = `${formattedDate}-v${versionNumber + 1}`;
            } else {
                // Nouvelle date, commencer à v1
                newVersion = `${formattedDate}-v1`;
            }
            
            // Mettre à jour la version
            allData.version = newVersion;
            
            // Mettre à jour les affichages
            document.getElementById('tableVersionInfo').textContent = `Version: ${newVersion}`;
            document.getElementById('editorVersionInfo').textContent = `Version: ${newVersion}`;
            
            // Mettre à jour l'éditeur JSON
            document.getElementById('json-editor').value = JSON.stringify(allData, null, 2);
            
            // Sauvegarder dans localStorage
            saveToLocalStorage();
            
            debug(`Version incrémentée à ${newVersion}`);
            showNotification('table-notification', `Version incrémentée à ${newVersion}`, 'success');
        } catch (error) {
            console.error('Erreur lors de l\'incrémentation de la version:', error);
            debug('Erreur lors de l\'incrémentation de la version', error);
            showNotification('table-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Exporter les données
    function exportData() {
        try {
            debug('Exportation des données...');
            
            // Vérifier si les données sont valides
            if (!allData) {
                showNotification('table-notification', 'Données non disponibles pour l\'exportation.', 'error');
                debug('Erreur: Données non disponibles pour l\'exportation');
                return;
            }
            
            // Convertir en JSON et télécharger
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `recyclage_batteries_ve_${timestamp}.json`;
            link.click();
            
            debug('Données exportées avec succès');
            showNotification('table-notification', 'Données exportées avec succès!', 'success');
        } catch (error) {
            console.error('Erreur lors de l\'exportation:', error);
            debug('Erreur lors de l\'exportation', error);
            showNotification('table-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Importer un fichier JSON
    function importFile(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        
        debug(`Importation du fichier ${file.name}...`);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // Vérifier si le format est correct
                if (!data.refineries || !Array.isArray(data.refineries)) {
                    throw new Error('Format de fichier invalide: refineries manquantes ou non valides');
                }
                
                debug('Données JSON importées avec succès', data);
                
                // Mettre à jour les données
                allData = data;
                refineries = data.refineries;
                
                // Mise à jour de l'interface
                updateInterface();
                
                // Sauvegarder dans localStorage
                saveToLocalStorage();
                
                showNotification('table-notification', 'Fichier importé avec succès!', 'success');
            } catch (error) {
                console.error('Erreur lors de l\'importation:', error);
                debug('Erreur lors de l\'importation', error);
                showNotification('table-notification', `Erreur: ${error.message}`, 'error');
            }
        };
        reader.readAsText(file);
        
        // Réinitialiser l'input file pour permettre une nouvelle importation du même fichier
        event.target.value = '';
    }
    
    // Valider le JSON dans l'éditeur
    function validateJson() {
        debug('Validation du JSON...');
        
        const jsonText = document.getElementById('json-editor').value;
        const validatorElement = document.getElementById('json-validator');
        
        try {
            const data = JSON.parse(jsonText);
            
            // Vérifier si le format est correct
            if (!data.refineries || !Array.isArray(data.refineries)) {
                throw new Error('Format de données invalide: refineries manquantes ou non valides');
            }
            
            validatorElement.textContent = 'JSON valide!';
            validatorElement.style.color = '#27ae60';
            
            // Activer le bouton d'application
            document.getElementById('apply-btn').disabled = false;
            
            debug('JSON valide');
            showNotification('editor-notification', 'JSON valide!', 'success');
        } catch (error) {
            validatorElement.textContent = `Erreur: ${error.message}`;
            validatorElement.style.color = '#e74c3c';
            
            // Désactiver le bouton d'application
            document.getElementById('apply-btn').disabled = true;
            
            debug('Erreur de validation JSON', error);
            showNotification('editor-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Appliquer les modifications depuis l'éditeur JSON
    function applyJsonChanges() {
        debug('Application des modifications depuis l\'éditeur JSON...');
        
        const jsonText = document.getElementById('json-editor').value;
        
        try {
            const data = JSON.parse(jsonText);
            
            // Vérifier si le format est correct
            if (!data.refineries || !Array.isArray(data.refineries)) {
                throw new Error('Format de données invalide: refineries manquantes ou non valides');
            }
            
            // Mettre à jour les données
            allData = data;
            refineries = data.refineries;
            
            // Mise à jour de l'interface
            updateInterface();
            
            // Sauvegarder dans localStorage
            saveToLocalStorage();
            
            debug('Modifications JSON appliquées avec succès');
            showNotification('editor-notification', 'Modifications appliquées avec succès!', 'success');
        } catch (error) {
            console.error('Erreur lors de l\'application des modifications:', error);
            debug('Erreur lors de l\'application des modifications JSON', error);
            showNotification('editor-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Télécharger le JSON depuis l'éditeur
    function downloadJson() {
        debug('Téléchargement du JSON depuis l\'éditeur...');
        
        const jsonText = document.getElementById('json-editor').value;
        
        try {
            // Vérifier si le JSON est valide
            JSON.parse(jsonText);
            
            // Télécharger le fichier
            const dataBlob = new Blob([jsonText], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `refineries_${timestamp}.json`;
            link.click();
            
            debug('JSON téléchargé avec succès');
            showNotification('editor-notification', 'JSON téléchargé avec succès!', 'success');
        } catch (error) {
            console.error('Erreur lors du téléchargement du JSON:', error);
            debug('Erreur lors du téléchargement du JSON', error);
            showNotification('editor-notification', `Erreur: ${error.message}`, 'error');
        }
    }
    
    // Recharger le JSON depuis le fichier
    function reloadJson() {
        debug('Rechargement du JSON depuis le fichier...');
        
        loadData().then(success => {
            if (success) {
                debug('JSON rechargé avec succès depuis le fichier');
                showNotification('editor-notification', 'JSON rechargé avec succès depuis le fichier!', 'success');
            }
        });
    }
    
    // Afficher la modal GitHub
    function showGitHubModal() {
        debug('Affichage de la modal GitHub...');
        
        document.getElementById('github-modal').style.display = 'block';
        document.getElementById('github-message').value = `Mise à jour des données d'installations - ${new Date().toISOString().slice(0, 10)}`;
    }
    
    // Upload vers GitHub
    async function uploadToGitHub() {
        debug('Upload vers GitHub...');
        
        const token = document.getElementById('github-token').value;
        const commitMessage = document.getElementById('github-message').value || `Mise à jour des données - ${new Date().toISOString().slice(0, 10)}`;
        
        if (!token) {
            showNotification('table-notification', 'Token GitHub requis pour l\'upload.', 'error');
            debug('Erreur: Token GitHub manquant');
            return;
        }
        
        try {
            // Vérifier si les données sont valides
            if (!allData) {
                showNotification('table-notification', 'Données non disponibles pour l\'upload.', 'error');
                debug('Erreur: Données non disponibles pour l\'upload');
                return;
            }
            
            // Préparer les données
            const jsonContent = JSON.stringify(allData, null, 2);
            
            // Obtenir le SHA du fichier existant si disponible
            let fileSha = "";
            debug('Recherche du SHA du fichier existant...');
            
            try {
                const repoInfoResponse = await fetch('https://api.github.com/repos/tofunori/Lithium-Dashboard/contents/data/refineries.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (repoInfoResponse.ok) {
                    const repoInfo = await repoInfoResponse.json();
                    fileSha = repoInfo.sha;
                    debug(`SHA trouvé: ${fileSha}`);
                } else {
                    debug(`Erreur lors de la récupération du SHA: ${repoInfoResponse.status}`);
                }
            } catch (error) {
                console.warn('Impossible d\'obtenir le SHA du fichier existant:', error);
                debug('Erreur lors de la récupération du SHA', error);
            }
            
            // Encoder le contenu en base64
            const base64Content = btoa(unescape(encodeURIComponent(jsonContent)));
            
            // Préparer la requête
            const requestBody = {
                message: commitMessage,
                content: base64Content,
                branch: 'main'
            };
            
            if (fileSha) {
                requestBody.sha = fileSha;
            }
            
            debug('Envoi de la requête PUT vers GitHub...', requestBody);
            
            // Afficher une notification de chargement
            showNotification('table-notification', 'Upload en cours...', 'info');
            
            // Effectuer la requête
            const response = await fetch('https://api.github.com/repos/tofunori/Lithium-Dashboard/contents/data/refineries.json', {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                debug('Erreur de la requête GitHub', errorData);
                throw new Error(`Erreur GitHub (${response.status}): ${errorData.message}`);
            }
            
            const result = await response.json();
            debug('Réponse GitHub', result);
            
            // Fermer la modal
            document.getElementById('github-modal').style.display = 'none';
            
            debug('Upload GitHub réussi');
            showNotification('table-notification', 'Fichier uploadé avec succès vers GitHub!', 'success');
        } catch (error) {
            console.error('Erreur lors de l\'upload vers GitHub:', error);
            debug('Erreur lors de l\'upload vers GitHub', error);
            showNotification('table-notification', `Erreur lors de l'upload: ${error.message}`, 'error');
        }
    }
    
    // Afficher une notification
    function showNotification(elementId, message, type) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`Élément de notification '${elementId}' non trouvé!`);
            debug(`Erreur: Élément de notification '${elementId}' non trouvé!`);
            return;
        }
        
        // Définir le type de notification
        element.className = `notification ${type}`;
        element.textContent = message;
        element.style.display = 'block';
        
        // Masquer la notification après 5 secondes
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
        
        debug(`Notification ${type}: ${message}`);
    }
    
    // Rendre les fonctions disponibles globalement
    window.editRefinery = editRefinery;
    window.deleteRefinery = deleteRefinery;
    window.logout = logout;
    </script>
</body>
</html>